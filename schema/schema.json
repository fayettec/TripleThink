{
  "$schema": "https://triplethink-engine.dev/v4.1/schema",
  "schema_version": "4.1.0",
  "database": "SQLite3 with JSON1 extension",
  "description": "TripleThink v4.1 - Event-Sourced Narrative Construction Database with Hybrid State Architecture",

  "tables": {
    "projects": {
      "description": "Series-level metadata container",
      "purpose": "Organize narratives into distinct projects",
      "columns": {
        "id": { "type": "TEXT PRIMARY KEY", "format": "proj-*", "description": "Unique project identifier" },
        "name": { "type": "TEXT NOT NULL", "description": "Project name" },
        "author": { "type": "TEXT", "description": "Author name" },
        "description": { "type": "TEXT", "description": "Project description" },
        "schema_version": { "type": "TEXT DEFAULT '4.1.0'", "description": "Schema version used" },
        "meta_id": { "type": "TEXT", "description": "Link to metadata record" },
        "read_metadata_mandatory": { "type": "INTEGER DEFAULT 0", "description": "Flag to always load metadata" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" },
        "updated_at": { "type": "TIMESTAMP", "description": "Last update timestamp" }
      }
    },

    "metadata": {
      "description": "Separated metadata for token efficiency",
      "purpose": "Store author notes, AI guidance, dev status separately",
      "columns": {
        "id": { "type": "TEXT PRIMARY KEY", "format": "meta-*", "description": "Unique metadata identifier" },
        "entity_id": { "type": "TEXT NOT NULL", "description": "References any entity" },
        "entity_type": { "type": "TEXT CHECK(...)", "description": "Type of entity this metadata describes" },
        "author_notes": { "type": "JSON", "description": "Creative intent, themes, constraints" },
        "ai_guidance": { "type": "JSON", "description": "Tone, scene rendering, POV recommendations" },
        "dev_status": { "type": "JSON", "description": "Completeness, TODOs, uncertainties, warnings" },
        "version_info": { "type": "JSON NOT NULL", "description": "Created, modified, changelog" },
        "prose_guidance": { "type": "JSON", "description": "Voice, tone, pacing notes" },
        "consistency_rules": { "type": "JSON", "description": "Array of consistency rules" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" },
        "updated_at": { "type": "TIMESTAMP", "description": "Last update timestamp" }
      }
    },

    "entities": {
      "description": "Polymorphic entity storage (characters, events, objects, locations, systems)",
      "purpose": "Single table for all narrative entities with type discrimination",
      "columns": {
        "id": { "type": "TEXT PRIMARY KEY", "format": "evt-*, char-*, obj-*, loc-*, sys-*", "description": "Unique entity identifier" },
        "entity_type": { "type": "TEXT CHECK(...)", "description": "Type: event, character, object, location, system" },
        "name": { "type": "TEXT NOT NULL", "description": "Entity name" },
        "timestamp": { "type": "TIMESTAMP", "description": "When event occurred (for events)" },
        "summary": { "type": "TEXT", "description": "Brief description" },
        "data": { "type": "JSON NOT NULL", "description": "Type-specific structured data" },
        "meta_id": { "type": "TEXT", "description": "Link to metadata" },
        "read_metadata_mandatory": { "type": "INTEGER DEFAULT 0", "description": "Always load metadata" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" },
        "updated_at": { "type": "TIMESTAMP", "description": "Last update timestamp" }
      }
    },

    "event_phases": {
      "description": "Multi-phase event structure (breaking complex events into beats)",
      "purpose": "Model events as sequences of phases with state changes",
      "columns": {
        "id": { "type": "TEXT PRIMARY KEY", "format": "phase-*", "description": "Unique phase identifier" },
        "event_id": { "type": "TEXT NOT NULL FK", "description": "Parent event" },
        "sequence": { "type": "INTEGER NOT NULL", "description": "Order within event" },
        "timestamp": { "type": "TIMESTAMP NOT NULL", "description": "When this phase occurred" },
        "summary": { "type": "TEXT", "description": "Phase summary" },
        "participants": { "type": "JSON NOT NULL", "description": "Array of entity IDs involved" },
        "state_changes": { "type": "JSON", "description": "Array of {entity_id, property, before, after}" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" }
      }
    },

    "facts": {
      "description": "Ground truth facts created by events",
      "purpose": "Source of truth for what actually happened",
      "columns": {
        "id": { "type": "TEXT PRIMARY KEY", "format": "fact-*", "description": "Unique fact identifier" },
        "phase_id": { "type": "TEXT NOT NULL FK", "description": "Phase that created this fact" },
        "event_id": { "type": "TEXT NOT NULL FK", "description": "Parent event (denormalized)" },
        "content": { "type": "TEXT NOT NULL", "description": "What the fact states" },
        "visibility": { "type": "TEXT CHECK(...)", "description": "ground_truth, witnessed_by_crew, limited_knowledge, epistemic_state" },
        "confidence": { "type": "TEXT DEFAULT 'absolute'", "description": "absolute, high, medium, low" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" }
      }
    },

    "knowledge_states": {
      "description": "Epistemic tracking - who knows/believes what, when",
      "purpose": "Model character beliefs and knowledge evolution",
      "columns": {
        "id": { "type": "INTEGER PRIMARY KEY AUTOINCREMENT", "description": "Auto-generated ID" },
        "character_id": { "type": "TEXT NOT NULL FK", "description": "Character or system" },
        "timestamp": { "type": "TIMESTAMP NOT NULL", "description": "When this state became active" },
        "trigger_event_id": { "type": "TEXT NOT NULL FK", "description": "Event that caused this state" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" }
      }
    },

    "knowledge_state_facts": {
      "description": "Individual fact beliefs within a knowledge state",
      "purpose": "Track what a character believes about each fact",
      "columns": {
        "id": { "type": "INTEGER PRIMARY KEY AUTOINCREMENT", "description": "Auto-generated ID" },
        "knowledge_state_id": { "type": "INTEGER NOT NULL FK", "description": "Parent knowledge state" },
        "fact_id": { "type": "TEXT NOT NULL FK", "description": "Fact being tracked" },
        "belief": { "type": "TEXT CHECK(...)", "description": "true or false" },
        "believed_alternative": { "type": "TEXT", "description": "If false, what they believe instead" },
        "confidence": { "type": "TEXT", "description": "absolute, high, medium, low" },
        "source": { "type": "TEXT NOT NULL", "description": "direct_experience, told_by_X, etc." }
      }
    },

    "relationships": {
      "description": "Entity-to-entity relationships with timeline",
      "purpose": "Model connections between entities with temporal evolution",
      "columns": {
        "id": { "type": "INTEGER PRIMARY KEY AUTOINCREMENT", "description": "Auto-generated ID" },
        "from_entity_id": { "type": "TEXT NOT NULL FK", "description": "Source entity" },
        "to_entity_id": { "type": "TEXT NOT NULL FK", "description": "Target entity" },
        "relationship_type": { "type": "TEXT NOT NULL", "description": "colleague, friend, owns, etc." },
        "timestamp": { "type": "TIMESTAMP NOT NULL", "description": "When relationship began" },
        "data": { "type": "JSON", "description": "sentiment, trust_level, etc." },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" }
      }
    },

    "timeline_versions": {
      "description": "Branching timelines for 'what if' scenarios",
      "purpose": "Enable narrative branching and alternate timeline exploration",
      "columns": {
        "id": { "type": "TEXT PRIMARY KEY", "format": "ver-*", "description": "Unique version identifier" },
        "project_id": { "type": "TEXT NOT NULL FK", "description": "Parent project" },
        "parent_version_id": { "type": "TEXT FK", "description": "Parent timeline (if branched)" },
        "branch_point_event_id": { "type": "TEXT FK", "description": "Event where divergence occurred" },
        "name": { "type": "TEXT NOT NULL", "description": "Version name" },
        "is_active": { "type": "INTEGER DEFAULT 0", "description": "1 if currently active timeline" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" }
      }
    },

    "asset_state_snapshots": {
      "description": "Full state dumps at anchor points (hybrid state architecture)",
      "purpose": "Enable efficient state reconstruction without traversing entire event log",
      "columns": {
        "id": { "type": "TEXT PRIMARY KEY", "format": "snap-*", "description": "Unique snapshot identifier" },
        "timeline_version_id": { "type": "TEXT NOT NULL FK", "description": "Which timeline branch" },
        "asset_id": { "type": "TEXT NOT NULL FK", "description": "Entity being snapshotted" },
        "anchor_event_id": { "type": "TEXT NOT NULL FK", "description": "Event this snapshot anchors to" },
        "snapshot_type": { "type": "TEXT NOT NULL", "description": "chapter_start, major_event, periodic, manual" },
        "state_json": { "type": "TEXT NOT NULL", "description": "Complete JSON state at anchor point" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" }
      },
      "indexes": ["asset_id, anchor_event_id", "anchor_event_id"]
    },

    "asset_state_deltas": {
      "description": "Incremental changes between snapshots",
      "purpose": "Efficient storage of state changes between snapshots",
      "columns": {
        "id": { "type": "TEXT PRIMARY KEY", "format": "delta-*", "description": "Unique delta identifier" },
        "timeline_version_id": { "type": "TEXT NOT NULL FK", "description": "Which timeline branch" },
        "asset_id": { "type": "TEXT NOT NULL FK", "description": "Entity being changed" },
        "event_id": { "type": "TEXT NOT NULL FK", "description": "Event that caused change" },
        "previous_snapshot_id": { "type": "TEXT FK", "description": "Nearest prior snapshot" },
        "changes_json": { "type": "TEXT NOT NULL", "description": "Only the diff from previous state" },
        "change_category": { "type": "TEXT", "description": "physical, psychological, knowledge, relationship, location, mixed" },
        "magnitude": { "type": "INTEGER DEFAULT 1", "description": "1-10 severity/importance" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" }
      },
      "indexes": ["asset_id, event_id"]
    },

    "causality_chains": {
      "description": "[Logic Layer] Cause-effect relationships between events",
      "purpose": "Track and validate story logic and causal consistency",
      "columns": {
        "id": { "type": "TEXT PRIMARY KEY", "format": "causal-*", "description": "Unique causality record ID" },
        "cause_event_id": { "type": "TEXT NOT NULL FK", "description": "Event that causes" },
        "effect_event_id": { "type": "TEXT NOT NULL FK", "description": "Event that is caused" },
        "type": { "type": "TEXT CHECK(...)", "description": "direct_cause, enabling_condition, motivation, psychological_trigger" },
        "strength": { "type": "INTEGER 1-10", "description": "How strong is the causal link" },
        "explanation": { "type": "TEXT", "description": "Why this causal link exists" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" }
      },
      "indexes": ["cause_event_id", "effect_event_id"]
    },

    "character_arcs": {
      "description": "[Logic Layer] Character transformation arcs (Save the Cat structure)",
      "purpose": "Track character development and transformation",
      "columns": {
        "id": { "type": "TEXT PRIMARY KEY", "format": "arc-*", "description": "Unique arc identifier" },
        "character_id": { "type": "TEXT NOT NULL FK", "description": "Character being tracked" },
        "archetype": { "type": "TEXT", "description": "hero, anti-hero, tragic hero, etc." },
        "lie_belief": { "type": "TEXT", "description": "The lie the character believes" },
        "truth_belief": { "type": "TEXT", "description": "The truth they need to learn" },
        "want_external": { "type": "TEXT", "description": "What they think they want" },
        "need_internal": { "type": "TEXT", "description": "What they actually need" },
        "current_phase": { "type": "TEXT", "description": "Save the Cat phase progression" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" },
        "updated_at": { "type": "TIMESTAMP", "description": "Last update timestamp" }
      },
      "indexes": ["character_id"]
    },

    "story_conflicts": {
      "description": "[Logic Layer] Active conflicts, stakes, and opposition",
      "purpose": "Model story tension and dramatic stakes",
      "columns": {
        "id": { "type": "TEXT PRIMARY KEY", "format": "conflict-*", "description": "Unique conflict identifier" },
        "project_id": { "type": "TEXT NOT NULL FK", "description": "Parent project" },
        "type": { "type": "TEXT", "description": "internal, interpersonal, societal, environmental" },
        "protagonist_id": { "type": "TEXT NOT NULL FK", "description": "Primary character in conflict" },
        "antagonist_source": { "type": "TEXT", "description": "Character, force, or society" },
        "stakes_success": { "type": "TEXT", "description": "What happens if protagonist wins" },
        "stakes_fail": { "type": "TEXT", "description": "What happens if protagonist fails" },
        "status": { "type": "TEXT", "description": "latent, active, escalating, climactic, resolved" },
        "intensity": { "type": "INTEGER 1-10", "description": "Current conflict intensity" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" },
        "updated_at": { "type": "TIMESTAMP", "description": "Last update timestamp" }
      },
      "indexes": ["protagonist_id", "status"]
    },

    "thematic_elements": {
      "description": "[Logic Layer] Recurring themes and big ideas",
      "purpose": "Track thematic consistency and exploration",
      "columns": {
        "id": { "type": "TEXT PRIMARY KEY", "format": "theme-*", "description": "Unique theme identifier" },
        "project_id": { "type": "TEXT NOT NULL FK", "description": "Parent project" },
        "statement": { "type": "TEXT NOT NULL", "description": "Theme statement (e.g., 'Power corrupts')" },
        "question": { "type": "TEXT", "description": "Thematic question being explored" },
        "primary_symbol_id": { "type": "TEXT FK", "description": "Optional symbolic entity" },
        "description": { "type": "TEXT", "description": "How theme manifests in story" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" }
      },
      "indexes": ["project_id"]
    },

    "motif_instances": {
      "description": "[Logic Layer] Recurring patterns (visual, dialogue, situational)",
      "purpose": "Track and reinforce narrative patterns",
      "columns": {
        "id": { "type": "TEXT PRIMARY KEY", "format": "motif-*", "description": "Unique motif instance ID" },
        "project_id": { "type": "TEXT NOT NULL FK", "description": "Parent project" },
        "motif_name": { "type": "TEXT NOT NULL", "description": "Name of recurring pattern" },
        "motif_type": { "type": "TEXT", "description": "visual, dialogue, situational, symbolic, musical" },
        "event_id": { "type": "TEXT NOT NULL FK", "description": "Event where this instance appears" },
        "description": { "type": "TEXT", "description": "How it manifests" },
        "variation_notes": { "type": "TEXT", "description": "How this instance varies from others" },
        "thematic_element_id": { "type": "TEXT FK", "description": "Optional link to theme" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" }
      },
      "indexes": ["project_id", "event_id", "motif_name"]
    },

    "setup_payoffs": {
      "description": "[Logic Layer] Chekhov's guns, foreshadowing, clues, red herrings",
      "purpose": "Track story promises and their fulfillment",
      "columns": {
        "id": { "type": "TEXT PRIMARY KEY", "format": "setup-*", "description": "Unique setup/payoff record ID" },
        "project_id": { "type": "TEXT NOT NULL FK", "description": "Parent project" },
        "setup_event_id": { "type": "TEXT NOT NULL FK", "description": "Where gun is planted" },
        "payoff_event_id": { "type": "TEXT FK", "description": "Where it fires (NULL if unfired)" },
        "setup_type": { "type": "TEXT", "description": "chekhov_gun, foreshadowing, promise, clue, red_herring" },
        "setup_description": { "type": "TEXT NOT NULL", "description": "What was planted" },
        "payoff_description": { "type": "TEXT", "description": "How it paid off" },
        "status": { "type": "TEXT", "description": "planted, referenced, fired, abandoned" },
        "importance": { "type": "INTEGER 1-10", "description": "Importance/impact level" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" },
        "updated_at": { "type": "TIMESTAMP", "description": "Last update timestamp" }
      },
      "indexes": ["project_id", "setup_event_id", "status"]
    },

    "world_rules": {
      "description": "[Logic Layer] Universe consistency (magic systems, tech limits, cultural norms)",
      "purpose": "Ensure world consistency and catch violations",
      "columns": {
        "id": { "type": "TEXT PRIMARY KEY", "format": "rule-*", "description": "Unique rule identifier" },
        "project_id": { "type": "TEXT NOT NULL FK", "description": "Parent project" },
        "category": { "type": "TEXT", "description": "physics, magic_system, technology, cultural, historical, biological, societal, metaphysical" },
        "rule_name": { "type": "TEXT NOT NULL", "description": "Name of rule" },
        "rule_statement": { "type": "TEXT NOT NULL", "description": "Clear statement of what the rule is" },
        "constraints": { "type": "TEXT", "description": "Limitations and edge cases" },
        "consequences": { "type": "TEXT", "description": "What happens when violated" },
        "exceptions": { "type": "TEXT", "description": "Known exceptions" },
        "established_event_id": { "type": "TEXT FK", "description": "Event where rule is established" },
        "is_hard_rule": { "type": "INTEGER DEFAULT 1", "description": "1 = cannot break, 0 = can bend" },
        "created_at": { "type": "TIMESTAMP", "description": "Creation timestamp" },
        "updated_at": { "type": "TIMESTAMP", "description": "Last update timestamp" }
      },
      "indexes": ["project_id", "category"]
    }
  },

  "relationships": {
    "projects": "Parent container for all data",
    "entities": "Can be events (root nodes), characters, objects, locations",
    "event_phases": "Events → Phases → Facts (event decomposition)",
    "knowledge_states": "Characters → Knowledge States → Fact Beliefs",
    "timeline_versions": "Enable narrative branching from any event",
    "snapshots_and_deltas": "Hybrid state: anchors + incremental changes",
    "logic_layer": "Causality, arcs, conflicts, themes track story structure"
  },

  "query_patterns": {
    "state_at_event": "Find nearest snapshot + apply delta chain to target event",
    "character_knowledge": "Get knowledge states for character ordered by timestamp",
    "causal_chain": "Traverse causality_chains graph for root causes",
    "story_consistency": "Check facts against world_rules",
    "narrative_structure": "Review character_arcs, story_conflicts, setup_payoffs together"
  },

  "performance_targets": {
    "state_reconstruction": "< 100ms for 100-delta chain",
    "epistemic_query": "< 100ms for character knowledge state",
    "causal_chain_traversal": "< 200ms for 50-event chain",
    "total_storage_10_book_series": "< 50MB"
  },

  "notes": {
    "immutability": "Events are immutable. Never edit events, only add new ones.",
    "id_format": "All IDs are random (using nanoid or similar). Prefix indicates type.",
    "json_storage": "Uses SQLite JSON1 extension for nested data",
    "epistemic_core": "knowledge_states + knowledge_state_facts form the epistemology engine",
    "hybrid_state_strategy": "Snapshots at chapter starts + major events; deltas between; reconstruction via nearest snapshot + delta chain"
  }
}
