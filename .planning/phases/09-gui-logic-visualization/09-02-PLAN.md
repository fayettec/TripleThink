---
phase: 09-gui-logic-visualization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - gui/js/components/causality-graph.js
  - gui/index.html
autonomous: true

must_haves:
  truths:
    - "User can see causal graph visualization for events"
    - "User can control traversal depth with slider (1-10)"
    - "Graph uses color-coded arrows for relationship types"
    - "Graph limits to 50 nodes maximum for performance"
  artifacts:
    - path: "gui/js/components/causality-graph.js"
      provides: "D3 force-directed graph with depth control"
      min_lines: 80
      exports: ["CausalityGraph"]
  key_links:
    - from: "causality-graph.js"
      to: "api.getCausalityGraph()"
      via: "fetches graph data with depth parameter"
      pattern: "api\\.getCausalityGraph"
    - from: "causality-graph.js"
      to: "D3.js library"
      via: "uses d3.forceSimulation for layout"
      pattern: "d3\\.forceSimulation|d3\\.select"
---

<objective>
Create D3-powered causality graph visualization component with interactive depth control and color-coded relationship types.

Purpose: Enable users to explore causal relationships between events visually, fulfilling GUI-10, GUI-11, GUI-12 requirements.

Output: Standalone CausalityGraph component ready for integration into Story Logic screen's Causality tab (Plan 03 will wire it).
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# API client context - getCausalityGraph() method
@gui/js/api-client.js

# State management for causalityDepth
@gui/js/state.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add D3.js library to index.html</name>
  <files>gui/index.html</files>
  <action>
    Add D3.js v7 CDN script tag in the &lt;head&gt; section BEFORE other script tags.

    Use: &lt;script src="https://d3js.org/d3.v7.min.js"&gt;&lt;/script&gt;

    Place after CSS link, before component/screen scripts.

    D3 v7 is the latest stable version. We need d3.forceSimulation, d3.select, d3.drag, d3.zoom which are all in core D3 v7.
  </action>
  <verify>
    - D3 script tag present in index.html head
    - D3 version 7.x loaded
    - Opening browser console and typing 'd3' shows object (confirms library loaded)
  </verify>
  <done>
    D3.js library available globally for visualization components
  </done>
</task>

<task type="auto">
  <name>Task 2: Create causality-graph.js component with D3 force-directed layout</name>
  <files>gui/js/components/causality-graph.js</files>
  <action>
    Create CausalityGraph component as global object.

    Provide render(containerId, eventId, depth) method:
    - containerId: DOM element ID to render graph into (e.g., 'causality-graph-container')
    - eventId: starting event UUID for traversal
    - depth: traversal depth (1-10, default from state.causalityDepth or 3)

    Implementation:
    1. Call api.getCausalityGraph(eventId, depth) to get graph data
    2. Graph data structure (from Phase 3):
       {
         nodes: [{ id: event_uuid, label: event_name, type: 'event' }],
         edges: [{ source: event_uuid, target: event_uuid, type: 'direct-cause'|'enabling-condition'|'motivation'|'psychological-trigger', strength: 1-10 }]
       }
    3. If nodes.length > 50, truncate to first 50 nodes and show warning
    4. Use D3 force simulation:
       - d3.forceSimulation(nodes)
       - forceLink(edges) with id accessor
       - forceManyBody() for repulsion
       - forceCenter() to center in container
    5. Draw edges as SVG lines with color based on type:
       - direct-cause: red (#e74c3c)
       - enabling-condition: blue (#3498db)
       - motivation: purple (#9b59b6)
       - psychological-trigger: orange (#e67e22)
    6. Draw nodes as SVG circles with event labels
    7. Add zoom and drag behaviors
    8. Add arrow markers to edges (directed graph)

    Color mapping constant:
    const EDGE_COLORS = {
      'direct-cause': '#e74c3c',
      'enabling-condition': '#3498db',
      'motivation': '#9b59b6',
      'psychological-trigger': '#e67e22'
    };

    SVG dimensions: Use container width/height, or default to 800x600.

    Graph physics:
    - Link distance: 100px
    - Charge strength: -300 (repulsion)
    - Collision radius: 30px

    Node rendering:
    - Circle radius: 20px
    - Fill: var(--color-surface-light)
    - Stroke: var(--color-border)
    - Label: text element below circle

    Edge rendering:
    - Stroke width: proportional to strength (1-10 â†’ 1-5px)
    - Arrow markers at end
    - Opacity: 0.8

    Provide updateDepth(newDepth) method:
    - Re-fetches graph with new depth
    - Re-renders simulation
    - Called when depth slider changes
  </action>
  <verify>
    - causality-graph.js file exists with CausalityGraph object
    - render() method creates SVG with D3
    - Edge colors match relationship types
    - Graph renders with force simulation physics
    - Nodes draggable, graph zoomable
  </verify>
  <done>
    CausalityGraph component renders D3 force-directed graph with color-coded edges
  </done>
</task>

<task type="auto">
  <name>Task 3: Add depth control slider and node limit warning</name>
  <files>gui/js/components/causality-graph.js</files>
  <action>
    Extend CausalityGraph component with control panel.

    Provide renderControls(containerId) method:
    - Creates control panel div with:
      - Depth slider: &lt;input type="range" min="1" max="10" value="3" /&gt;
      - Current depth display: "Depth: 3"
      - Node count display: "Showing X nodes"
      - Warning badge if truncated: "Limited to 50 nodes"

    Slider change handler:
    - Updates state.update({ causalityDepth: newValue })
    - Calls updateDepth(newValue) to re-render graph

    Node limit logic (in render() method):
    - If graph.nodes.length > 50:
      - Truncate to first 50 nodes
      - Filter edges to only include those connecting remaining nodes
      - Set truncated flag
      - Display warning: "Graph limited to 50 nodes for performance. Reduce depth to see different nodes."

    Control panel styling:
    - Positioned above graph container
    - Flex layout: slider + labels in row
    - Warning badge: orange background, white text
    - Depth slider: full-width or 200px

    Integrate renderControls() call in render() method:
    - Clear container first
    - Render controls div
    - Render SVG below controls
  </action>
  <verify>
    - Depth slider renders above graph
    - Moving slider updates state.causalityDepth
    - Graph re-renders with new depth when slider changes
    - Warning shows when >50 nodes truncated
    - Node count display accurate
  </verify>
  <done>
    Causality graph has depth control slider and node limit handling
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] D3.js library loaded (check browser console for 'd3' object)
- [ ] CausalityGraph.render() can be called standalone with test event ID
- [ ] Graph renders with force-directed layout (nodes repel, links connect)
- [ ] Edge colors match type mapping (red for direct-cause, blue for enabling-condition, etc.)
- [ ] Depth slider updates graph when moved
- [ ] Nodes draggable, graph zoomable/pannable
- [ ] Warning appears when graph has >50 nodes
- [ ] No console errors
</verification>

<success_criteria>
- All tasks completed
- D3.js library integrated
- CausalityGraph component renders force-directed graph
- Color-coded edges by relationship type (4 colors)
- Depth slider controls traversal depth (1-10)
- 50-node limit enforced with warning
- No errors or warnings introduced
- Component ready for integration into Story Logic screen (Plan 03)
</success_criteria>

<output>
After completion, create `.planning/phases/09-gui-logic-visualization/09-02-SUMMARY.md`
</output>
