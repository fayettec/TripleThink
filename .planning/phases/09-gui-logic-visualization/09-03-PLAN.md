---
phase: 09-gui-logic-visualization
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - gui/js/components/theme-card.js
  - gui/js/components/motif-card.js
  - gui/js/components/setup-payoff-list.js
  - gui/js/screens/story-logic.js
  - gui/index.html
autonomous: true

must_haves:
  truths:
    - "User can see themes with manifestations"
    - "User can see motif instances grouped by type"
    - "User can see setup/payoff tracking with unfired warnings"
    - "All 6 tabs in Story Logic screen display real data"
  artifacts:
    - path: "gui/js/components/theme-card.js"
      provides: "Theme display with symbol and manifestations"
      min_lines: 25
    - path: "gui/js/components/motif-card.js"
      provides: "Motif instance display"
      min_lines: 20
    - path: "gui/js/components/setup-payoff-list.js"
      provides: "Chekhov's gun tracker with status"
      min_lines: 40
  key_links:
    - from: "story-logic.js Themes tab"
      to: "api.getThematicElements()"
      via: "loads theme data"
      pattern: "api\\.getThematicElements"
    - from: "story-logic.js Setup/Payoffs tab"
      to: "api.getUnfiredSetups()"
      via: "loads unfired setups"
      pattern: "api\\.getUnfiredSetups"
    - from: "story-logic.js Causality tab"
      to: "CausalityGraph.render()"
      via: "renders graph component"
      pattern: "CausalityGraph\\.render"
---

<objective>
Create remaining story logic components (themes, motifs, setups) and integrate all 6 tabs in Story Logic screen.

Purpose: Complete the Story Logic visualization feature, fulfilling GUI-13 and finalizing GUI-07 with all tabs functional.

Output: Fully functional Story Logic screen with all 6 tabs displaying live data from logic layer APIs.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Dependencies from Plan 01
@.planning/phases/09-gui-logic-visualization/09-01-SUMMARY.md

# API client methods
@gui/js/api-client.js

# Story Logic screen structure (created in Plan 01)
@gui/js/screens/story-logic.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create theme-card.js component for thematic element display</name>
  <files>gui/js/components/theme-card.js</files>
  <action>
    Create ThemeCard component as global object following ArcCard/ConflictCard pattern.

    Provide render(themeData) method that returns HTML string.

    themeData structure (from api.getThematicElements()):
    {
      theme_uuid: string,
      statement: string,
      primary_symbol_id: string (nullable),
      question: string (nullable),
      manifestations: array of strings
    }

    Display:
    - Statement as card title (bold, larger text)
    - Question as subtitle (italic, smaller text) if present
    - Primary symbol reference if present (e.g., "Symbol: {symbol_id}")
    - Manifestations list:
      - Title: "Manifestations" or "How this theme appears"
      - Bullet list of manifestation strings
      - If manifestations array empty, show "No manifestations recorded"

    Style: card layout similar to ArcCard. Manifestations in &lt;ul&gt; list.

    Example output:
    &lt;div class="theme-card"&gt;
      &lt;h3&gt;{statement}&lt;/h3&gt;
      &lt;p class="theme-question"&gt;{question}&lt;/p&gt;
      &lt;div class="theme-manifestations"&gt;
        &lt;h4&gt;Manifestations&lt;/h4&gt;
        &lt;ul&gt;
          &lt;li&gt;{manifestation 1}&lt;/li&gt;
          &lt;li&gt;{manifestation 2}&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  </action>
  <verify>
    - theme-card.js file exists with ThemeCard object
    - ThemeCard.render() returns HTML string
    - Handles nullable question and primary_symbol_id
    - Manifestations render as list
  </verify>
  <done>
    ThemeCard component renders thematic elements with statement, question, and manifestations
  </done>
</task>

<task type="auto">
  <name>Task 2: Create motif-card.js component for motif instance display</name>
  <files>gui/js/components/motif-card.js</files>
  <action>
    Create MotifCard component as global object.

    Provide render(motifData) method that returns HTML string.

    motifData structure (from api.getMotifInstances()):
    {
      motif_uuid: string,
      motif_type: string,
      linked_entity_id: string (nullable),
      description: string,
      significance: string (nullable)
    }

    Display:
    - Motif type badge (similar to conflict type badges)
    - Description as main text
    - Significance as secondary text (if present)
    - Linked entity reference (if present): "Linked to: {entity_id}"

    Motif type colors (use consistent palette):
    - Use single color for all types (e.g., --color-accent or teal)
    - Badge shows type text

    Style: card layout similar to other cards. Badge + text content.

    Example:
    &lt;div class="motif-card"&gt;
      &lt;span class="badge motif-badge"&gt;{motif_type}&lt;/span&gt;
      &lt;p class="motif-description"&gt;{description}&lt;/p&gt;
      &lt;p class="motif-significance"&gt;Significance: {significance}&lt;/p&gt;
    &lt;/div&gt;
  </action>
  <verify>
    - motif-card.js file exists with MotifCard object
    - MotifCard.render() returns HTML string
    - Handles nullable significance and linked_entity_id
  </verify>
  <done>
    MotifCard component renders motif instances with type, description, and significance
  </done>
</task>

<task type="auto">
  <name>Task 3: Create setup-payoff-list.js component for Chekhov's gun tracking</name>
  <files>gui/js/components/setup-payoff-list.js</files>
  <action>
    Create SetupPayoffList component as global object.

    Provide render(containerId) method:
    - containerId: DOM element ID to render into
    - Fetches all setup/payoffs with api.getSetupPayoffs()
    - Fetches unfired setups with api.getUnfiredSetups()
    - Displays list with status-based grouping and warnings

    Setup/payoff data structure:
    {
      setup_uuid: string,
      setup_event_id: string,
      payoff_event_id: string (nullable),
      description: string,
      status: string (one of: planted, referenced, fired),
      planted_chapter: string (nullable),
      fired_chapter: string (nullable)
    }

    Display structure:
    - Section header: "Setup/Payoff Tracking (Chekhov's Gun)"
    - Warning banner if unfired setups exist:
      "‚ö†Ô∏è {count} setups planted but not fired"
    - List grouped by status:
      - "Planted" (yellow indicator)
      - "Referenced" (blue indicator)
      - "Fired" (green checkmark)
    - Each item shows:
      - Description
      - Planted in: {planted_chapter}
      - Fired in: {fired_chapter} (if status === 'fired')
      - Event IDs (setup_event_id, payoff_event_id if present)

    Status indicators:
    - planted: üü° or yellow dot
    - referenced: üîµ or blue dot
    - fired: ‚úÖ or green checkmark

    Unfired warning:
    - Highlight unfired setups (status === 'planted' or 'referenced')
    - Orange background for unfired items
    - Warning banner at top with count

    Provide renderList(setupPayoffs, unfiredSetups) helper:
    - setupPayoffs: all setups
    - unfiredSetups: filtered list from getUnfiredSetups()
    - Returns grouped HTML structure
  </action>
  <verify>
    - setup-payoff-list.js file exists with SetupPayoffList object
    - render() fetches data and displays list
    - Status grouping works (planted, referenced, fired sections)
    - Unfired warning appears when unfired setups exist
    - Each item shows description, chapters, and status
  </verify>
  <done>
    SetupPayoffList component renders setup/payoff tracker with unfired warnings
  </done>
</task>

<task type="auto">
  <name>Task 4: Integrate all components into Story Logic tabs</name>
  <files>gui/js/screens/story-logic.js</files>
  <action>
    Update StoryLogicScreen to wire all 6 tabs with components.

    Tab implementations (update renderTabContent() method or equivalent):

    **Arcs tab** (already done in Plan 01):
    - Fetch with api.getCharacterArcs()
    - Render ArcCard.render(arc) for each

    **Conflicts tab** (already done in Plan 01):
    - Fetch with api.getStoryConflicts()
    - Render ConflictCard.render(conflict) for each

    **Causality tab** (integrate Plan 02):
    - Render causality graph controls and container
    - Call CausalityGraph.render('causality-graph-container', selectedEventId, depth)
    - If no event selected, show: "Select an event to view causal graph" with event picker (or use first event from api.getEvents())
    - Include depth slider from CausalityGraph.renderControls()

    **Themes tab** (new):
    - Fetch with api.getThematicElements()
    - Render ThemeCard.render(theme) for each
    - If no themes, show: "No themes defined yet"

    **Motifs tab** (new):
    - Fetch with api.getMotifInstances()
    - Render MotifCard.render(motif) for each
    - If no motifs, show: "No motifs recorded yet"

    **Setup/Payoffs tab** (new):
    - Render SetupPayoffList.render('setup-payoff-container')
    - Component handles fetching and display

    Update tab switching logic:
    - When tab clicked, update state.activeTab
    - Clear content container
    - Call appropriate render method for tab
    - Handle loading states (show "Loading..." while fetching)

    Empty state handling:
    - Each tab shows helpful message if no data
    - Link to documentation or "Add new {entity}" prompt
  </action>
  <verify>
    - All 6 tabs functional when clicked
    - Arcs tab shows character arcs
    - Conflicts tab shows story conflicts
    - Causality tab shows D3 graph with controls
    - Themes tab shows thematic elements
    - Motifs tab shows motif instances
    - Setup/Payoffs tab shows Chekhov's gun tracker
    - Empty states show helpful messages
  </verify>
  <done>
    Story Logic screen complete with all 6 tabs displaying live data
  </done>
</task>

<task type="auto">
  <name>Task 5: Add script tags for new components</name>
  <files>gui/index.html</files>
  <action>
    Add script tags for new components in correct loading order (before app.js):

    &lt;script src="js/components/theme-card.js"&gt;&lt;/script&gt;
    &lt;script src="js/components/motif-card.js"&gt;&lt;/script&gt;
    &lt;script src="js/components/setup-payoff-list.js"&gt;&lt;/script&gt;
    &lt;script src="js/components/causality-graph.js"&gt;&lt;/script&gt;

    Insert after arc-card.js and conflict-card.js, before story-logic.js screen.

    Final loading order in script section:
    1. D3.js (from CDN)
    2. api-client.js
    3. state.js
    4. Components:
       - power-drawer.js
       - layer-switcher.js
       - arc-card.js
       - conflict-card.js
       - theme-card.js
       - motif-card.js
       - setup-payoff-list.js
       - causality-graph.js
    5. Screens:
       - timeline.js
       - epistemic.js
       - characters.js
       - story-logic.js
    6. router.js
    7. app.js
  </action>
  <verify>
    - All component script tags present in index.html
    - Loading order correct (components before screens before app.js)
    - No missing dependencies
  </verify>
  <done>
    All components loaded in correct order, ready for use by Story Logic screen
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Navigate to http://localhost:8080/#story-logic
- [ ] Click through all 6 tabs (Arcs, Conflicts, Causality, Themes, Motifs, Setup/Payoffs)
- [ ] Each tab displays appropriate data or empty state message
- [ ] Causality tab shows D3 graph with depth slider
- [ ] Setup/Payoffs tab shows unfired warning if applicable
- [ ] No console errors in browser DevTools
- [ ] Power drawer accessible from Story Logic screen
- [ ] All components render without layout breaks
</verification>

<success_criteria>
- All tasks completed
- ThemeCard, MotifCard, SetupPayoffList components created
- All 6 tabs in Story Logic screen functional
- Each tab displays live data from API
- Empty states handled gracefully
- CausalityGraph integrated into Causality tab
- No errors or warnings introduced
- Phase 9 complete - GUI Logic Visualization ready
</success_criteria>

<output>
After completion, create `.planning/phases/09-gui-logic-visualization/09-03-SUMMARY.md`
</output>
