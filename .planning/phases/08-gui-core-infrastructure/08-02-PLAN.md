---
phase: 08-gui-core-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - gui/js/state.js
  - gui/js/components/power-drawer.js
  - gui/js/components/layer-switcher.js
  - gui/styles/components.css
autonomous: true

must_haves:
  truths:
    - "Application state persists across interactions"
    - "Components can subscribe to state changes"
    - "Power drawer can toggle open/closed"
    - "Layer switcher can change view mode"
  artifacts:
    - path: "gui/js/state.js"
      provides: "Centralized state management with pub/sub"
      exports: ["state"]
      min_lines: 50
    - path: "gui/js/components/power-drawer.js"
      provides: "Slide-out inspection panel"
      exports: ["PowerDrawer"]
      min_lines: 80
    - path: "gui/js/components/layer-switcher.js"
      provides: "Epistemic layer toggle"
      exports: ["LayerSwitcher"]
      min_lines: 60
    - path: "gui/styles/components.css"
      provides: "Component styling"
      min_lines: 100
  key_links:
    - from: "power-drawer.js"
      to: "state.js"
      via: "state.subscribe and state.update"
      pattern: "state\\.(subscribe|update)"
    - from: "layer-switcher.js"
      to: "state.js viewMode"
      via: "state.update({ viewMode })"
      pattern: "state\\.update.*viewMode"
---

<objective>
Create state management system and core v4.1 components (power drawer, layer switcher).

Purpose: Implement centralized state with pub/sub pattern to enable reactive UI updates. Build power drawer for advanced inspection and layer switcher for epistemic view toggling. These components are foundational for all future GUI features (Phases 9-12).

Output: Working state management, power drawer component that can toggle open/closed, layer switcher that updates viewMode state.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/codebase/STACK.md
@.planning/codebase/CONVENTIONS.md
@.planning/phases/08-gui-core-infrastructure/08-01-SUMMARY.md

**From Plan 01:**
- GUI structure exists (directories, index.html)
- api-client.js singleton available for data fetching

**Requirements satisfied:**
- GUI-03: layer-switcher.js toggles World Truth, Character View, Reader View
- GUI-04: Layer switcher updates state.js viewMode
- GUI-06: state.js has v4.1 fields (currentProjectId, currentTimestamp, selectedCharacter, viewMode, powerDrawerOpen, causalityDepth, activeTab)

**State fields needed (from roadmap):**
- currentProjectId: string | null
- currentTimestamp: number | null (for temporal queries)
- selectedCharacter: string | null (character ID for Character View layer)
- viewMode: 'world-truth' | 'character-view' | 'reader-view'
- powerDrawerOpen: boolean
- causalityDepth: number (1-10, default 3)
- activeTab: string (for multi-tab screens like story-logic)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create state.js with pub/sub pattern</name>
  <files>gui/js/state.js</files>
  <action>
    Create gui/js/state.js as centralized state manager:

    **Structure:**
    ```javascript
    class State {
      constructor() {
        this.data = {
          // Project context
          currentProjectId: null,
          currentTimestamp: null,
          selectedCharacter: null,

          // View configuration
          viewMode: 'world-truth', // 'world-truth' | 'character-view' | 'reader-view'
          powerDrawerOpen: false,
          causalityDepth: 3,
          activeTab: null,

          // Future: add more fields as needed by Phases 9-12
        };

        this.subscribers = new Map(); // key: string, value: Set<function>
      }

      get(key) {
        return this.data[key];
      }

      getAll() {
        return { ...this.data }; // Return copy to prevent mutation
      }

      update(changes) {
        // changes: object with key-value pairs to update
        // Example: state.update({ viewMode: 'character-view', selectedCharacter: 'char-alice' })

        const changedKeys = [];
        for (const [key, value] of Object.entries(changes)) {
          if (this.data[key] !== value) {
            this.data[key] = value;
            changedKeys.push(key);
          }
        }

        // Notify subscribers for changed keys
        changedKeys.forEach(key => this.notify(key));
      }

      subscribe(key, callback) {
        // Subscribe to changes for specific key
        // Returns unsubscribe function
        if (!this.subscribers.has(key)) {
          this.subscribers.set(key, new Set());
        }
        this.subscribers.get(key).add(callback);

        return () => {
          this.subscribers.get(key).delete(callback);
        };
      }

      notify(key) {
        // Notify all subscribers for this key
        if (this.subscribers.has(key)) {
          const value = this.data[key];
          this.subscribers.get(key).forEach(callback => callback(value));
        }
      }
    }

    // Export singleton
    const state = new State();
    ```

    **Conventions:**
    - camelCase for method names and properties
    - Immutable getAll() returns copy
    - subscribe() returns unsubscribe function (standard pattern)
  </action>
  <verify>
    - File exists: ls gui/js/state.js
    - Contains State class: grep -q "class State" gui/js/state.js
    - Has all v4.1 fields: grep -q "viewMode\|powerDrawerOpen\|causalityDepth\|activeTab" gui/js/state.js
    - Exports singleton: grep -q "const state = new State" gui/js/state.js
    - Syntax valid: node --check gui/js/state.js
  </verify>
  <done>state.js exists with State class, pub/sub methods, all v4.1 fields initialized, singleton exported</done>
</task>

<task type="auto">
  <name>Task 2: Create power-drawer.js component</name>
  <files>gui/js/components/power-drawer.js, gui/styles/components.css</files>
  <action>
    Create gui/js/components/power-drawer.js as slide-out inspection panel:

    **Component structure:**
    ```javascript
    const PowerDrawer = {
      init() {
        // Create drawer DOM structure and append to body
        const drawer = document.createElement('div');
        drawer.id = 'power-drawer';
        drawer.className = 'power-drawer';
        drawer.innerHTML = `
          <div class="power-drawer-header">
            <h3>Advanced Inspection</h3>
            <button class="power-drawer-close" aria-label="Close">&times;</button>
          </div>
          <div class="power-drawer-content">
            <p>Power drawer content will be populated by screens in Phase 11+</p>
          </div>
        `;
        document.body.appendChild(drawer);

        // Wire up close button
        drawer.querySelector('.power-drawer-close').addEventListener('click', () => {
          PowerDrawer.close();
        });

        // Subscribe to state changes
        state.subscribe('powerDrawerOpen', (isOpen) => {
          if (isOpen) {
            drawer.classList.add('open');
          } else {
            drawer.classList.remove('open');
          }
        });
      },

      open() {
        state.update({ powerDrawerOpen: true });
      },

      close() {
        state.update({ powerDrawerOpen: false });
      },

      toggle() {
        const isOpen = state.get('powerDrawerOpen');
        state.update({ powerDrawerOpen: !isOpen });
      },

      setContent(html) {
        // Allow screens to populate drawer content
        const content = document.querySelector('.power-drawer-content');
        if (content) {
          content.innerHTML = html;
        }
      }
    };
    ```

    **Add CSS to gui/styles/components.css:**
    ```css
    /* Power Drawer */
    .power-drawer {
      position: fixed;
      right: -400px; /* Hidden by default */
      top: 0;
      width: 400px;
      height: 100vh;
      background: #fff;
      box-shadow: -2px 0 8px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: right 0.3s ease;
      display: flex;
      flex-direction: column;
    }

    .power-drawer.open {
      right: 0; /* Slide in */
    }

    .power-drawer-header {
      padding: 1rem;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .power-drawer-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: #666;
    }

    .power-drawer-close:hover {
      color: #000;
    }

    .power-drawer-content {
      padding: 1rem;
      overflow-y: auto;
      flex: 1;
    }
    ```

    **Requirement GUI-01**: slide-out panel for advanced inspection ✓
  </action>
  <verify>
    - File exists: ls gui/js/components/power-drawer.js
    - Has PowerDrawer object: grep -q "const PowerDrawer" gui/js/components/power-drawer.js
    - Has init/open/close/toggle methods: grep -c "init\|open\|close\|toggle" gui/js/components/power-drawer.js
    - Subscribes to powerDrawerOpen: grep -q "state.subscribe.*powerDrawerOpen" gui/js/components/power-drawer.js
    - CSS exists: grep -q ".power-drawer" gui/styles/components.css
    - Syntax valid: node --check gui/js/components/power-drawer.js
  </verify>
  <done>power-drawer.js component created with init/open/close/toggle methods, subscribes to state, CSS styling added</done>
</task>

<task type="auto">
  <name>Task 3: Create layer-switcher.js component</name>
  <files>gui/js/components/layer-switcher.js, gui/styles/components.css</files>
  <action>
    Create gui/js/components/layer-switcher.js for epistemic layer toggling:

    **Component structure:**
    ```javascript
    const LayerSwitcher = {
      init(containerId) {
        // Render layer switcher in specified container
        // Called by screens that need layer switching

        const container = document.getElementById(containerId);
        if (!container) {
          console.error(`LayerSwitcher: container #${containerId} not found`);
          return;
        }

        const currentMode = state.get('viewMode');

        container.innerHTML = `
          <div class="layer-switcher">
            <button class="layer-btn ${currentMode === 'world-truth' ? 'active' : ''}"
                    data-mode="world-truth">
              World Truth
            </button>
            <button class="layer-btn ${currentMode === 'character-view' ? 'active' : ''}"
                    data-mode="character-view">
              Character View
            </button>
            <button class="layer-btn ${currentMode === 'reader-view' ? 'active' : ''}"
                    data-mode="reader-view">
              Reader View
            </button>
          </div>
        `;

        // Wire up click handlers
        container.querySelectorAll('.layer-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const mode = btn.dataset.mode;
            LayerSwitcher.setMode(mode);
          });
        });

        // Subscribe to state changes to update active button
        state.subscribe('viewMode', (newMode) => {
          container.querySelectorAll('.layer-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === newMode);
          });
        });
      },

      setMode(mode) {
        // Validate mode
        const validModes = ['world-truth', 'character-view', 'reader-view'];
        if (!validModes.includes(mode)) {
          console.error(`Invalid viewMode: ${mode}`);
          return;
        }

        state.update({ viewMode: mode });
      },

      getMode() {
        return state.get('viewMode');
      }
    };
    ```

    **Add CSS to gui/styles/components.css:**
    ```css
    /* Layer Switcher */
    .layer-switcher {
      display: flex;
      gap: 0.5rem;
      padding: 0.5rem;
      background: #f5f5f5;
      border-radius: 4px;
    }

    .layer-btn {
      padding: 0.5rem 1rem;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.2s ease;
    }

    .layer-btn:hover {
      background: #e8e8e8;
    }

    .layer-btn.active {
      background: #007bff;
      color: #fff;
      border-color: #007bff;
    }
    ```

    **Requirements:**
    - GUI-03: Toggles World Truth, Character View, Reader View ✓
    - GUI-04: Updates state.js viewMode ✓
  </action>
  <verify>
    - File exists: ls gui/js/components/layer-switcher.js
    - Has LayerSwitcher object: grep -q "const LayerSwitcher" gui/js/components/layer-switcher.js
    - Has init/setMode/getMode methods: grep -c "init\|setMode\|getMode" gui/js/components/layer-switcher.js
    - Updates viewMode: grep -q "state.update.*viewMode" gui/js/components/layer-switcher.js
    - CSS exists: grep -q ".layer-switcher" gui/styles/components.css
    - Syntax valid: node --check gui/js/components/layer-switcher.js
  </verify>
  <done>layer-switcher.js component created with init/setMode/getMode methods, updates state viewMode, CSS styling added</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] state.js has State class with all v4.1 fields
- [ ] state.js has subscribe/update/notify methods
- [ ] power-drawer.js has init/open/close/toggle methods
- [ ] power-drawer subscribes to powerDrawerOpen state
- [ ] layer-switcher.js has init/setMode/getMode methods
- [ ] layer-switcher updates viewMode state
- [ ] components.css has styles for both components
- [ ] No JavaScript syntax errors
</verification>

<success_criteria>
- All tasks completed
- State management works (update triggers notifications)
- Power drawer can toggle open/closed via state
- Layer switcher updates viewMode in state
- Components follow vanilla JS conventions (no frameworks)
- Code follows naming conventions (CONVENTIONS.md)
</success_criteria>

<output>
After completion, create `.planning/phases/08-gui-core-infrastructure/08-02-SUMMARY.md`
</output>
