---
phase: 02-logic-layer-schema
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [db/migrations/006_logic_layer.sql]
autonomous: true

# Goal-backward verification
must_haves:
  truths:
    - "Migration file contains all 7 logic layer table definitions"
    - "Each table has appropriate columns per requirements (LOGIC-01 through LOGIC-07)"
    - "Tables follow event sourcing principles (append-only, created_at timestamps)"
    - "Indexes are defined for foreign keys and common query patterns"
  artifacts:
    - path: "db/migrations/006_logic_layer.sql"
      provides: "CREATE TABLE statements for all 7 logic layer tables"
      min_lines: 150
      contains: "CAUSALITY_CHAINS"
  key_links:
    - from: "006_logic_layer.sql"
      to: "database schema"
      via: "run-migration.js execution in Plan 02-02"
      pattern: "CREATE TABLE IF NOT EXISTS"
---

<objective>
Create migration script defining all 7 logic layer tables for story structure tracking.

Purpose: Establish database schema foundation for causality, arcs, conflicts, themes, motifs, setup/payoffs, and world rules tracking. This enables Phase 3 (module creation) and Phase 7 (API exposure).

Output: Single migration file (006_logic_layer.sql) with all table definitions, ready for execution in Plan 02-02.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Prior phase context
@.planning/phases/01-foundation-enhancement/01-01-SUMMARY.md

# Codebase patterns
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

# Reference migration for pattern matching
@db/migrations/005_event_moments.sql

# Requirements this plan satisfies
Phase 2 Requirements:
- LOGIC-01: CAUSALITY_CHAINS table exists with cause_event_id, effect_event_id, type, strength (1-10), explanation
- LOGIC-02: CHARACTER_ARCS table exists with character_id, archetype, lie_belief, truth_belief, want_external, need_internal, current_phase
- LOGIC-03: STORY_CONFLICTS table exists with type, protagonist_id, antagonist_source, stakes_success, stakes_fail, status
- LOGIC-04: THEMATIC_ELEMENTS table exists with project_id, statement, primary_symbol_id, question, manifestations
- LOGIC-05: MOTIF_INSTANCES table exists with motif_type, linked_entity_id, description, significance
- LOGIC-06: SETUP_PAYOFFS table exists with setup_event_id, payoff_event_id, description, status, planted_chapter, fired_chapter
- LOGIC-07: WORLD_RULES table exists with rule_category, statement, exceptions, enforcement_level
</context>

<tasks>

<task type="auto">
  <name>Task 1: Design CAUSALITY_CHAINS, CHARACTER_ARCS, STORY_CONFLICTS schemas</name>
  <files>db/migrations/006_logic_layer.sql</files>
  <action>
Create migration file header with v4.1 Phase 2 context, then define first 3 tables:

**CAUSALITY_CHAINS** - Cause-effect relationship tracking
- chain_uuid TEXT PRIMARY KEY
- project_id TEXT NOT NULL
- cause_event_id TEXT NOT NULL (will reference events.event_uuid in future)
- effect_event_id TEXT NOT NULL (will reference events.event_uuid in future)
- type TEXT NOT NULL (values: 'direct_cause', 'enabling_condition', 'motivation', 'psychological_trigger')
- strength INTEGER NOT NULL CHECK(strength >= 1 AND strength <= 10)
- explanation TEXT NOT NULL
- created_at INTEGER NOT NULL
- Indexes: idx_causality_project, idx_causality_cause, idx_causality_effect

**CHARACTER_ARCS** - Character transformation tracking following Save the Cat
- arc_uuid TEXT PRIMARY KEY
- project_id TEXT NOT NULL
- character_id TEXT NOT NULL (references entities where entity_type='character')
- archetype TEXT (e.g., 'hero', 'mentor', 'shadow', 'trickster')
- lie_belief TEXT (false belief character holds at story start)
- truth_belief TEXT (truth character must learn)
- want_external TEXT (external goal character pursues)
- need_internal TEXT (internal need character must fulfill)
- current_phase TEXT (values: 'setup', 'catalyst', 'debate', 'break_into_two', 'b_story', 'fun_and_games', 'midpoint', 'bad_guys_close_in', 'all_is_lost', 'dark_night_of_soul', 'break_into_three', 'finale', 'final_image')
- created_at INTEGER NOT NULL
- Indexes: idx_arcs_project, idx_arcs_character

**STORY_CONFLICTS** - Conflict escalation tracking
- conflict_uuid TEXT PRIMARY KEY
- project_id TEXT NOT NULL
- type TEXT NOT NULL (values: 'internal', 'interpersonal', 'societal', 'environmental', 'supernatural')
- protagonist_id TEXT NOT NULL (references entities where entity_type='character')
- antagonist_source TEXT NOT NULL (can be character ID, system ID, or descriptive string)
- stakes_success TEXT NOT NULL (what protagonist gains if they win)
- stakes_fail TEXT NOT NULL (what protagonist loses if they fail)
- status TEXT NOT NULL DEFAULT 'latent' (values: 'latent', 'active', 'escalating', 'climactic', 'resolved')
- created_at INTEGER NOT NULL
- Indexes: idx_conflicts_project, idx_conflicts_protagonist, idx_conflicts_status

Follow Phase 1 pattern: header comments explaining purpose, IF NOT EXISTS clauses, deferred foreign key constraints (EVENTS table doesn't exist yet, will be created in future phase).
  </action>
  <verify>
cat db/migrations/006_logic_layer.sql | grep -E "CREATE TABLE|INDEX" confirms all 3 tables and indexes present
  </verify>
  <done>CAUSALITY_CHAINS, CHARACTER_ARCS, STORY_CONFLICTS tables defined with all required columns and indexes</done>
</task>

<task type="auto">
  <name>Task 2: Add THEMATIC_ELEMENTS and MOTIF_INSTANCES schemas</name>
  <files>db/migrations/006_logic_layer.sql</files>
  <action>
Append to migration file:

**THEMATIC_ELEMENTS** - Theme and symbolic meaning tracking
- theme_uuid TEXT PRIMARY KEY
- project_id TEXT NOT NULL
- statement TEXT NOT NULL (the thematic statement or message)
- primary_symbol_id TEXT (optional reference to entity used as primary symbol)
- question TEXT (thematic question story explores)
- manifestations TEXT (JSON array of ways theme appears in story)
- created_at INTEGER NOT NULL
- Indexes: idx_themes_project

**MOTIF_INSTANCES** - Recurring pattern tracking
- motif_uuid TEXT PRIMARY KEY
- project_id TEXT NOT NULL
- motif_type TEXT NOT NULL (values: 'visual', 'dialogue', 'situational', 'symbolic', 'musical')
- linked_entity_id TEXT (optional reference to entity if motif is object-based)
- description TEXT NOT NULL
- significance TEXT (what the recurring pattern means/represents)
- created_at INTEGER NOT NULL
- Indexes: idx_motifs_project, idx_motifs_type
  </action>
  <verify>
wc -l db/migrations/006_logic_layer.sql shows file growing (should be 100+ lines by now)
  </verify>
  <done>THEMATIC_ELEMENTS and MOTIF_INSTANCES tables defined with proper structure</done>
</task>

<task type="auto">
  <name>Task 3: Add SETUP_PAYOFFS and WORLD_RULES schemas with final indexes</name>
  <files>db/migrations/006_logic_layer.sql</files>
  <action>
Complete migration file with final 2 tables:

**SETUP_PAYOFFS** - Chekhov's gun tracking
- setup_payoff_uuid TEXT PRIMARY KEY
- project_id TEXT NOT NULL
- setup_event_id TEXT NOT NULL (references events.event_uuid when table exists)
- payoff_event_id TEXT (references events.event_uuid, NULL until fired)
- description TEXT NOT NULL (what was set up / what pays off)
- status TEXT NOT NULL DEFAULT 'planted' (values: 'planted', 'referenced', 'fired', 'unfired')
- planted_chapter TEXT (chapter/scene where setup planted)
- fired_chapter TEXT (chapter/scene where setup fires, NULL until fired)
- created_at INTEGER NOT NULL
- Indexes: idx_setup_payoffs_project, idx_setup_payoffs_status, idx_setup_payoffs_setup_event

**WORLD_RULES** - Universe consistency rules
- rule_uuid TEXT PRIMARY KEY
- project_id TEXT NOT NULL
- rule_category TEXT NOT NULL (values: 'physics', 'magic', 'technology', 'social', 'biological', 'metaphysical')
- statement TEXT NOT NULL (the rule definition)
- exceptions TEXT (documented exceptions to the rule)
- enforcement_level TEXT NOT NULL DEFAULT 'strict' (values: 'strict', 'flexible', 'guideline')
- created_at INTEGER NOT NULL
- Indexes: idx_world_rules_project, idx_world_rules_category

Add file-level comment block at end noting that:
- All tables follow event sourcing (append-only)
- Foreign key constraints to EVENTS table deferred (EVENTS table will be created in future phase)
- These tables enable Phase 3 (module creation) and Phase 7 (API exposure)
  </action>
  <verify>
sqlite3 :memory: < db/migrations/006_logic_layer.sql && echo "Migration syntax valid"
  </verify>
  <done>All 7 logic layer tables defined with complete schema, ready for execution in Plan 02-02</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] db/migrations/006_logic_layer.sql file exists
- [ ] File contains CREATE TABLE statements for all 7 tables (CAUSALITY_CHAINS, CHARACTER_ARCS, STORY_CONFLICTS, THEMATIC_ELEMENTS, MOTIF_INSTANCES, SETUP_PAYOFFS, WORLD_RULES)
- [ ] Each table has PRIMARY KEY, project_id, created_at columns
- [ ] Tables follow requirements LOGIC-01 through LOGIC-07 exactly
- [ ] Indexes defined for foreign keys and common query patterns
- [ ] Migration file has no syntax errors (verified with sqlite3)
</verification>

<success_criteria>

- All tasks completed
- Migration file syntactically valid
- All 7 tables defined with proper columns per requirements
- Pattern matches existing migrations (005_event_moments.sql)
- Ready for execution in Plan 02-02
  </success_criteria>

<output>
After completion, create `.planning/phases/02-logic-layer-schema/02-01-SUMMARY.md`
</output>
