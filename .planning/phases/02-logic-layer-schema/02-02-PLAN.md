---
phase: 02-logic-layer-schema
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified: [db/triplethink.db, db/.migrations-applied]
autonomous: true

# Goal-backward verification
must_haves:
  truths:
    - "Database contains CAUSALITY_CHAINS table with proper schema"
    - "Database contains CHARACTER_ARCS table with proper schema"
    - "Database contains STORY_CONFLICTS table with proper schema"
    - "Database contains THEMATIC_ELEMENTS table with proper schema"
    - "Database contains MOTIF_INSTANCES table with proper schema"
    - "Database contains SETUP_PAYOFFS table with proper schema"
    - "Database contains WORLD_RULES table with proper schema"
    - "All tables accept INSERT operations without constraint violations"
  artifacts:
    - path: "db/triplethink.db"
      provides: "SQLite database with 7 new logic layer tables"
    - path: "db/.migrations-applied"
      provides: "Migration tracking confirming 006 was applied"
      contains: "006_logic_layer.sql"
  key_links:
    - from: "006_logic_layer.sql"
      to: "db/triplethink.db"
      via: "run-migration.js execution"
      pattern: "sqlite3.*006_logic_layer"
    - from: "table schemas"
      to: "future CRUD modules"
      via: "Phase 3 will use these tables"
---

<objective>
Execute migration script and verify all 7 logic layer tables exist with correct structure.

Purpose: Apply the migration created in Plan 02-01, transforming database schema to include story structure tracking tables. Verification ensures Phase 3 (module creation) can proceed.

Output: Database with 7 new tables, verified schema structure, migration tracking updated.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plan in this phase
@.planning/phases/02-logic-layer-schema/02-01-SUMMARY.md

# Migration to execute
@db/migrations/006_logic_layer.sql

# Migration runner
@db/run-migration.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Execute migration 006_logic_layer.sql</name>
  <files>db/triplethink.db, db/.migrations-applied</files>
  <action>
Run migration using the established migration runner:

```bash
cd /app
node db/run-migration.js 006_logic_layer.sql
```

The run-migration.js script:
1. Reads db/migrations/006_logic_layer.sql
2. Connects to db/triplethink.db
3. Executes all CREATE TABLE and CREATE INDEX statements
4. Records migration in db/.migrations-applied
5. Outputs success confirmation

If migration was already applied (idempotent), script should skip cleanly.
  </action>
  <verify>
cat db/.migrations-applied | grep "006_logic_layer.sql" confirms migration recorded
  </verify>
  <done>Migration 006 executed, db/.migrations-applied updated</done>
</task>

<task type="auto">
  <name>Task 2: Query schema to verify all 7 tables exist</name>
  <files>None (read-only verification)</files>
  <action>
Use SQLite to query schema and confirm all 7 tables present:

```bash
sqlite3 db/triplethink.db "SELECT name FROM sqlite_master WHERE type='table' AND name LIKE '%_chains' OR name LIKE '%_arcs' OR name LIKE '%_conflicts' OR name LIKE '%_elements' OR name LIKE '%_instances' OR name LIKE '%_payoffs' OR name LIKE '%_rules' ORDER BY name;"
```

Expected output (7 rows):
- causality_chains
- character_arcs
- motif_instances
- setup_payoffs
- story_conflicts
- thematic_elements
- world_rules

Then verify column structure for each table matches requirements:

```bash
sqlite3 db/triplethink.db ".schema causality_chains"
sqlite3 db/triplethink.db ".schema character_arcs"
sqlite3 db/triplethink.db ".schema story_conflicts"
sqlite3 db/triplethink.db ".schema thematic_elements"
sqlite3 db/triplethink.db ".schema motif_instances"
sqlite3 db/triplethink.db ".schema setup_payoffs"
sqlite3 db/triplethink.db ".schema world_rules"
```

Verify each table has:
- UUID primary key
- project_id column
- created_at column
- Requirement-specific columns (LOGIC-01 through LOGIC-07)
  </action>
  <verify>
All 7 tables listed in sqlite_master, .schema output shows correct column names for each table
  </verify>
  <done>Schema verified - all tables exist with proper structure</done>
</task>

<task type="auto">
  <name>Task 3: Test basic INSERT operations to validate constraints</name>
  <files>None (read-only test operations, rolled back)</files>
  <action>
Test each table accepts INSERT with valid data:

```bash
sqlite3 db/triplethink.db <<EOF
BEGIN TRANSACTION;

-- Test CAUSALITY_CHAINS
INSERT INTO causality_chains (chain_uuid, project_id, cause_event_id, effect_event_id, type, strength, explanation, created_at)
VALUES ('test-chain-1', 'test-project', 'evt-1', 'evt-2', 'direct_cause', 8, 'Test causality', strftime('%s', 'now'));

-- Test CHARACTER_ARCS
INSERT INTO character_arcs (arc_uuid, project_id, character_id, archetype, lie_belief, truth_belief, want_external, need_internal, current_phase, created_at)
VALUES ('test-arc-1', 'test-project', 'char-1', 'hero', 'I am alone', 'Connection is strength', 'Defeat villain', 'Accept help', 'setup', strftime('%s', 'now'));

-- Test STORY_CONFLICTS
INSERT INTO story_conflicts (conflict_uuid, project_id, type, protagonist_id, antagonist_source, stakes_success, stakes_fail, status, created_at)
VALUES ('test-conflict-1', 'test-project', 'interpersonal', 'char-1', 'char-2', 'Gains respect', 'Loses everything', 'latent', strftime('%s', 'now'));

-- Test THEMATIC_ELEMENTS
INSERT INTO thematic_elements (theme_uuid, project_id, statement, question, manifestations, created_at)
VALUES ('test-theme-1', 'test-project', 'Power corrupts absolutely', 'Can power be wielded responsibly?', '["Ring symbolism", "Character descent"]', strftime('%s', 'now'));

-- Test MOTIF_INSTANCES
INSERT INTO motif_instances (motif_uuid, project_id, motif_type, description, significance, created_at)
VALUES ('test-motif-1', 'test-project', 'visual', 'Red door appears', 'Represents choice', strftime('%s', 'now'));

-- Test SETUP_PAYOFFS
INSERT INTO setup_payoffs (setup_payoff_uuid, project_id, setup_event_id, description, status, planted_chapter, created_at)
VALUES ('test-setup-1', 'test-project', 'evt-3', 'Gun on mantle', 'planted', 'Chapter 1', strftime('%s', 'now'));

-- Test WORLD_RULES
INSERT INTO world_rules (rule_uuid, project_id, rule_category, statement, enforcement_level, created_at)
VALUES ('test-rule-1', 'test-project', 'magic', 'Magic requires sacrifice', 'strict', strftime('%s', 'now'));

-- Check constraints: test strength out of range (should fail)
INSERT INTO causality_chains (chain_uuid, project_id, cause_event_id, effect_event_id, type, strength, explanation, created_at)
VALUES ('test-chain-bad', 'test-project', 'evt-1', 'evt-2', 'direct_cause', 15, 'Invalid strength', strftime('%s', 'now'));

ROLLBACK;
EOF
```

Expected behavior:
- First 7 INSERTs succeed (no errors)
- Final INSERT fails with CHECK constraint violation (strength must be 1-10)
- ROLLBACK cleans up test data

This confirms:
1. All tables accept valid data
2. Constraints are enforced
3. No unexpected schema issues
  </action>
  <verify>
Test INSERTs complete without errors (except intentional constraint violation), database remains unchanged after ROLLBACK
  </verify>
  <done>All 7 tables validated - accept INSERTs correctly, enforce constraints, ready for Phase 3 module development</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration 006_logic_layer.sql executed successfully
- [ ] db/.migrations-applied contains "006_logic_layer.sql"
- [ ] sqlite_master shows all 7 tables (causality_chains, character_arcs, story_conflicts, thematic_elements, motif_instances, setup_payoffs, world_rules)
- [ ] .schema output for each table matches requirements LOGIC-01 through LOGIC-07
- [ ] Test INSERTs confirm tables accept valid data
- [ ] Constraint validation works (invalid data rejected)
</verification>

<success_criteria>

- All tasks completed
- Migration executed and tracked
- All 7 tables exist in database
- Schema matches requirements exactly
- Basic operations validated
- Phase 2 complete, ready for Phase 3 (module creation)
  </success_criteria>

<output>
After completion, create `.planning/phases/02-logic-layer-schema/02-02-SUMMARY.md`
</output>
