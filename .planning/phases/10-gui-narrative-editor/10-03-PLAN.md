---
phase: 10-gui-narrative-editor
plan: 03
type: execute
wave: 3
depends_on: ["10-02"]
files_modified:
  - gui/js/components/narrative-tree-editor.js
  - gui/js/screens/narrative.js
  - gui/js/app.js
  - gui/index.html
autonomous: true

must_haves:
  truths:
    - "User can rename a chapter or scene"
    - "User can delete a chapter or scene with confirmation"
    - "User can access narrative editor from sidebar"
    - "Narrative screen renders without errors"
  artifacts:
    - path: "gui/js/components/narrative-tree-editor.js"
      provides: "Complete narrative editor with rename/delete"
      contains: "renameNode"
    - path: "gui/js/screens/narrative.js"
      provides: "Narrative screen integrating tree editor"
      exports: ["NarrativeScreen"]
      min_lines: 50
    - path: "gui/index.html"
      provides: "Navigation link to narrative screen"
      contains: "narrative"
  key_links:
    - from: "rename button click"
      to: "api.renameNarrativeNode"
      via: "event handler"
      pattern: "renameNarrativeNode"
    - from: "narrative.js"
      to: "NarrativeTreeEditor.render"
      via: "screen render call"
      pattern: "NarrativeTreeEditor\\.render"
---

<objective>
Complete narrative editor with rename/delete operations and integrate into narrative screen.

Purpose: Complete GUI-18 (rename/delete with confirmations), GUI-19 (narrative.js screen integration). This finalizes Phase 10 by providing a fully functional narrative structure editor accessible from the main navigation.

Output: Rename and delete operations, narrative.js screen with tree editor, route registration, sidebar navigation link.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-gui-narrative-editor/10-01-SUMMARY.md
@.planning/phases/10-gui-narrative-editor/10-02-SUMMARY.md

**From Plan 01:**
- NarrativeTreeEditor with drag-and-drop and API methods
- API client has renameNarrativeNode() and deleteNarrativeNode()

**From Plan 02:**
- Auto-renumbering after drag-and-drop
- Split and merge chapter operations
- CSS for tree editor

**Requirements:**
- GUI-18: Narrative tree editor supports rename/delete with confirmations
- GUI-19: narrative.js screen integrates narrative-tree-editor.js replacing old tree view

**Screen Pattern:**
Follow Phase 9 pattern (story-logic.js):
- Screen object with render() method
- Header with title and power drawer toggle
- Content area with component integration
- Route registration at bottom of file
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add rename and delete operations to narrative-tree-editor.js</name>
  <files>gui/js/components/narrative-tree-editor.js</files>
  <action>
    **Part A: Add action buttons to tree nodes**

    Update renderChapter() to include rename and delete buttons:
    ```javascript
    renderChapter(chapter, isLastChapter) {
      return `
        <div class="tree-chapter" draggable="true" data-id="${chapter.id}" data-type="chapter">
          <div class="chapter-header">
            <span class="chapter-number">Chapter ${chapter.number}</span>
            <span class="chapter-title">${chapter.title || 'Untitled'}</span>
            <span class="scene-count">(${chapter.scenes.length} scenes)</span>
            <div class="chapter-actions">
              <button class="btn-icon" onclick="NarrativeTreeEditor.showRenameDialog('${chapter.id}', 'chapter')" title="Rename Chapter">
                ‚úèÔ∏è
              </button>
              <button class="btn-icon" onclick="NarrativeTreeEditor.showSplitDialog('${chapter.id}')" title="Split Chapter">
                ‚úÇÔ∏è
              </button>
              ${!isLastChapter ? `
                <button class="btn-icon" onclick="NarrativeTreeEditor.mergeWithNext('${chapter.id}')" title="Merge with Next">
                  üîó
                </button>
              ` : ''}
              <button class="btn-icon btn-danger" onclick="NarrativeTreeEditor.showDeleteDialog('${chapter.id}', 'chapter')" title="Delete Chapter">
                üóëÔ∏è
              </button>
            </div>
          </div>
          <div class="chapter-scenes">
            ${chapter.scenes.map(scene => this.renderScene(scene)).join('')}
          </div>
        </div>
      `;
    }
    ```

    Update renderScene() to include rename and delete buttons:
    ```javascript
    renderScene(scene) {
      return `
        <div class="tree-scene" draggable="true" data-id="${scene.id}" data-type="scene">
          <span class="scene-number">${scene.sceneNumber}</span>
          <span class="scene-title">${scene.title || 'Untitled Scene'}</span>
          <span class="scene-status badge" style="background: ${this.getStatusColor(scene.status)}">${scene.status}</span>
          <div class="scene-actions">
            <button class="btn-icon" onclick="NarrativeTreeEditor.showRenameDialog('${scene.id}', 'scene')" title="Rename Scene">
              ‚úèÔ∏è
            </button>
            <button class="btn-icon btn-danger" onclick="NarrativeTreeEditor.showDeleteDialog('${scene.id}', 'scene')" title="Delete Scene">
              üóëÔ∏è
            </button>
          </div>
        </div>
      `;
    }

    getStatusColor(status) {
      const colors = {
        draft: '#6c757d',
        outline: '#ffc107',
        complete: '#28a745',
        revised: '#17a2b8'
      };
      return colors[status] || colors.draft;
    }
    ```

    **Part B: Add rename dialog and logic**

    ```javascript
    showRenameDialog(id, type) {
      // Find current title
      let currentTitle = '';
      if (type === 'chapter') {
        const chapter = this.data.chapters.find(ch => ch.id === id);
        currentTitle = chapter?.title || '';
      } else {
        for (const chapter of this.data.chapters) {
          const scene = chapter.scenes.find(s => s.id === id);
          if (scene) {
            currentTitle = scene.title || '';
            break;
          }
        }
      }

      // Prompt for new title (could be enhanced with modal)
      const newTitle = prompt(`Rename ${type}:`, currentTitle);
      if (newTitle === null || newTitle.trim() === '') return; // Cancelled or empty

      this.renameNode(id, type, newTitle.trim());
    }

    async renameNode(id, type, newTitle) {
      try {
        // Call API to rename
        await api.renameNarrativeNode(id, type, newTitle);

        // Re-render tree
        await this.render(this.data.fictionId);

        console.log(`${type} renamed to "${newTitle}"`);
      } catch (err) {
        console.error(`Rename ${type} failed:`, err);
        alert(`Failed to rename ${type}: ${err.message}`);
      }
    }
    ```

    **Part C: Add delete dialog and logic**

    ```javascript
    showDeleteDialog(id, type) {
      // Find entity name for confirmation
      let name = '';
      let hasChildren = false;

      if (type === 'chapter') {
        const chapter = this.data.chapters.find(ch => ch.id === id);
        name = chapter?.title || 'this chapter';
        hasChildren = chapter && chapter.scenes.length > 0;
      } else {
        for (const chapter of this.data.chapters) {
          const scene = chapter.scenes.find(s => s.id === id);
          if (scene) {
            name = scene.title || 'this scene';
            break;
          }
        }
      }

      // Confirmation message
      let message = `Delete ${type} "${name}"?`;
      if (hasChildren) {
        message += ` This will also delete ${hasChildren} scene(s).`;
      }
      message += ' This action cannot be undone.';

      const confirmed = confirm(message);
      if (!confirmed) return;

      this.deleteNode(id, type);
    }

    async deleteNode(id, type) {
      try {
        // Call API to delete
        await api.deleteNarrativeNode(id, type);

        // Re-render tree
        await this.render(this.data.fictionId);

        console.log(`${type} deleted: ${id}`);
      } catch (err) {
        console.error(`Delete ${type} failed:`, err);
        alert(`Failed to delete ${type}: ${err.message}`);
      }
    }
    ```

    **CSS updates:**
    Add to renderChapter/renderScene CSS section or components.css:
    ```css
    .chapter-actions,
    .scene-actions {
      display: flex;
      gap: 4px;
      margin-left: auto;
    }

    .btn-danger {
      color: #dc3545;
    }

    .btn-danger:hover {
      color: #c82333;
    }
    ```
  </action>
  <verify>
    - Rename and delete buttons appear on chapters and scenes
    - Clicking rename shows prompt with current title
    - Entering new title updates node and re-renders tree
    - Clicking delete shows confirmation dialog
    - Confirming delete removes node and re-renders tree
    - Deleting chapter with scenes shows warning about scene deletion
  </verify>
  <done>
    User can rename any chapter or scene, delete any chapter or scene with confirmation, tree updates after operations
  </done>
</task>

<task type="auto">
  <name>Task 2: Create narrative.js screen integrating tree editor</name>
  <files>gui/js/screens/narrative.js</files>
  <action>
    Create gui/js/screens/narrative.js following Phase 9 screen pattern:

    ```javascript
    /**
     * Narrative Screen
     * Narrative structure editor with drag-and-drop chapter/scene management
     */

    const NarrativeScreen = {
      async render() {
        const app = document.getElementById('app');

        // Get current project from state
        const currentProject = state.get('currentProjectId');

        if (!currentProject) {
          app.innerHTML = `
            <div class="screen narrative-screen">
              <header class="screen-header">
                <h1>üìñ Narrative Structure</h1>
                <button class="btn btn-icon" onclick="PowerDrawer.toggle()" title="Open Power Drawer">
                  <span>üîç</span>
                </button>
              </header>
              <div class="screen-content">
                <div class="empty-state">
                  <p class="empty-icon">üìö</p>
                  <p class="empty-message">No project selected</p>
                  <p class="empty-hint">Select a project to view narrative structure</p>
                </div>
              </div>
            </div>
          `;
          return;
        }

        // Render screen shell
        app.innerHTML = `
          <div class="screen narrative-screen">
            <header class="screen-header">
              <h1>üìñ Narrative Structure</h1>
              <div class="header-actions">
                <button class="btn btn-primary" onclick="NarrativeScreen.createChapter()">+ New Chapter</button>
                <button class="btn btn-primary" onclick="NarrativeScreen.createScene()">+ New Scene</button>
                <button class="btn btn-icon" onclick="PowerDrawer.toggle()" title="Open Power Drawer">
                  <span>üîç</span>
                </button>
              </div>
            </header>
            <div class="screen-content">
              <div class="narrative-info">
                <p class="help-text">
                  <strong>Drag & Drop:</strong> Reorder scenes and chapters. Auto-numbering applies after drop.
                  <br><strong>Actions:</strong> Use icons to rename ‚úèÔ∏è, split ‚úÇÔ∏è, merge üîó, or delete üóëÔ∏è.
                </p>
              </div>
              <div id="narrative-tree-container" class="tree-container">
                <p class="loading">Loading narrative structure...</p>
              </div>
            </div>
          </div>
        `;

        // Render tree editor
        const container = document.getElementById('narrative-tree-container');
        try {
          // Get fiction ID for current project (assuming 1:1 mapping or first fiction)
          const fictions = await api.request('/api/fictions');
          const fiction = fictions.data?.find(f => f.projectId === currentProject);

          if (!fiction) {
            container.innerHTML = `
              <div class="empty-state">
                <p class="empty-icon">üìñ</p>
                <p class="empty-message">No fiction found for this project</p>
                <p class="empty-hint">Create a fiction to start building narrative structure</p>
              </div>
            `;
            return;
          }

          // Render tree editor with fiction ID
          const treeHTML = await NarrativeTreeEditor.render(fiction.id);
          container.innerHTML = treeHTML;

          // Initialize drag handlers after DOM insertion
          NarrativeTreeEditor.setupDragHandlers();
        } catch (err) {
          console.error('Failed to load narrative structure:', err);
          container.innerHTML = `
            <div class="empty-state">
              <p class="empty-icon">‚ö†Ô∏è</p>
              <p class="empty-message">Failed to load narrative structure</p>
              <p class="empty-hint">${err.message}</p>
            </div>
          `;
        }
      },

      async createChapter() {
        const title = prompt('Chapter title:');
        if (!title) return;

        try {
          // Create chapter logic (simplified - may need API endpoint)
          console.log('Create chapter:', title);
          alert('Chapter creation not fully implemented yet - add via scene creation with new chapterId');
        } catch (err) {
          alert(`Failed to create chapter: ${err.message}`);
        }
      },

      async createScene() {
        const title = prompt('Scene title:');
        if (!title) return;

        try {
          const currentProject = state.get('currentProjectId');
          const fictions = await api.request('/api/fictions');
          const fiction = fictions.data?.find(f => f.projectId === currentProject);

          if (!fiction) {
            alert('No fiction found');
            return;
          }

          // Prompt for chapter ID or create unassigned scene
          const chapterId = prompt('Chapter ID (or leave empty for unassigned):');

          await api.request('/api/orchestrator/scenes', {
            method: 'POST',
            body: {
              fictionId: fiction.id,
              chapterId: chapterId || null,
              sceneNumber: 999, // Will be renumbered
              title: title,
              status: 'draft',
              narrativeTime: Date.now()
            }
          });

          // Re-render
          this.render();
        } catch (err) {
          alert(`Failed to create scene: ${err.message}`);
        }
      }
    };

    // For Node.js environments (testing)
    if (typeof module !== 'undefined' && module.exports) {
      module.exports = { NarrativeScreen };
    }
    ```

    **Pattern Notes:**
    - Async render() for API calls
    - Empty state handling (no project, no fiction, error)
    - Header with actions (new chapter/scene buttons)
    - Help text explaining drag-and-drop
    - Integration with NarrativeTreeEditor.render()
  </action>
  <verify>
    - narrative.js exports NarrativeScreen object
    - Screen has async render() method
    - Empty states display correctly
    - Tree editor renders in container
    - Help text explains interactions
    - New chapter/scene buttons present (even if stubbed)
  </verify>
  <done>
    Narrative screen renders with integrated tree editor, empty states handled, user guidance provided
  </done>
</task>

<task type="auto">
  <name>Task 3: Register narrative route and add sidebar navigation</name>
  <files>gui/js/app.js, gui/index.html</files>
  <action>
    **Part A: Register route in app.js**

    Add to gui/js/app.js after other route registrations:

    ```javascript
    // Register narrative screen
    Router.register('narrative', NarrativeScreen);
    ```

    Ensure NarrativeScreen is available (script tag loaded before app.js).

    **Part B: Add sidebar link in index.html**

    Add navigation link to sidebar in gui/index.html after story-logic link:

    ```html
    <li><a href="#narrative" class="nav-link" data-route="narrative">
      <span class="nav-icon">üìñ</span>
      <span class="nav-label">Narrative</span>
    </a></li>
    ```

    **Part C: Add script tag for narrative screen**

    Add to gui/index.html before app.js script tag:

    ```html
    <!-- Screens -->
    <script src="/js/screens/timeline.js"></script>
    <script src="/js/screens/epistemic.js"></script>
    <script src="/js/screens/characters.js"></script>
    <script src="/js/screens/story-logic.js"></script>
    <script src="/js/screens/narrative.js"></script>

    <!-- App Entry -->
    <script src="/js/app.js"></script>
    ```

    **Part D: Add script tag for narrative-tree-editor component**

    Add to gui/index.html in components section:

    ```html
    <!-- Components -->
    <script src="/js/components/power-drawer.js"></script>
    <script src="/js/components/layer-switcher.js"></script>
    <script src="/js/components/arc-card.js"></script>
    <script src="/js/components/conflict-card.js"></script>
    <script src="/js/components/causality-graph.js"></script>
    <script src="/js/components/theme-card.js"></script>
    <script src="/js/components/motif-card.js"></script>
    <script src="/js/components/setup-payoff-list.js"></script>
    <script src="/js/components/narrative-tree-editor.js"></script>
    ```

    **Verification:**
    - Click "Narrative" in sidebar
    - URL changes to #narrative
    - NarrativeScreen.render() is called
    - Tree editor appears
  </action>
  <verify>
    - Narrative link appears in sidebar
    - Clicking link navigates to #narrative
    - Narrative screen renders
    - Tree editor loads with chapters/scenes
    - No console errors
    - Route is registered in router
  </verify>
  <done>
    User can access Narrative screen from sidebar, route works, all components load correctly
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Rename operations work for chapters and scenes
- [ ] Delete operations work with confirmation dialogs
- [ ] Narrative screen renders and integrates tree editor
- [ ] Sidebar navigation link works
- [ ] Route registered in router
- [ ] No errors in console
- [ ] All Phase 10 requirements complete (GUI-14 through GUI-19)
</verification>

<success_criteria>

- Rename and delete operations functional (GUI-18)
- Narrative screen integrates tree editor (GUI-19)
- Route registered and accessible from sidebar
- All Phase 10 requirements satisfied
- Tree editor provides complete narrative management experience
  </success_criteria>

<output>
After completion, create `.planning/phases/10-gui-narrative-editor/10-03-SUMMARY.md`
</output>
