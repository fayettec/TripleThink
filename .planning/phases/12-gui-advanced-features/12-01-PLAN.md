---
phase: 12-gui-advanced-features
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [gui/js/components/relationship-map.js, gui/js/screens/dashboard.js, gui/js/api-client.js, gui/index.html, gui/js/app.js]
autonomous: true

must_haves:
  truths:
    - "User can visualize character relationships as an interactive graph"
    - "User can see trust, fear, respect, and power balance between characters"
    - "User can see unfired setups count on dashboard"
    - "User can see incomplete arcs count on dashboard"
    - "User can see unresolved conflicts count on dashboard"
  artifacts:
    - path: "gui/js/components/relationship-map.js"
      provides: "Vis.js network visualization of character relationships"
      min_lines: 150
    - path: "gui/js/screens/dashboard.js"
      provides: "Dashboard screen with v4.1 logic layer health stats"
      min_lines: 100
    - path: "gui/js/api-client.js"
      provides: "Relationship API methods"
      exports: ["getRelationships", "getRelationshipsFor"]
  key_links:
    - from: "relationship-map.js"
      to: "api.getRelationshipsFor"
      via: "fetches relationship data for fiction"
      pattern: "api\\.getRelationshipsFor"
    - from: "relationship-map.js"
      to: "Vis.js Network"
      via: "renders graph with new vis.Network()"
      pattern: "new vis\\.Network"
    - from: "dashboard.js"
      to: "api.getUnfiredSetups"
      via: "fetches unfired setups count"
      pattern: "api\\.getUnfiredSetups"
    - from: "dashboard.js"
      to: "api.getArcsForProject"
      via: "fetches character arcs to count incomplete"
      pattern: "api\\.getArcsForProject"
    - from: "dashboard.js"
      to: "api.getConflictsForProject"
      via: "fetches conflicts to count unresolved"
      pattern: "api\\.getConflictsForProject"
---

<objective>
Create relationship map visualization and enhance dashboard with v4.1 logic layer health stats.

Purpose: Provide visual insight into character relationships and story structure health. Relationship maps help authors track evolving dynamics. Dashboard stats surface unfired setups (Chekhov's guns), incomplete arcs, and unresolved conflicts that need attention.

Output: Relationship map component using Vis.js, dashboard screen with three v4.1 stat widgets, relationship API methods.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries
@.planning/phases/11-gui-epistemic-reader-knowledge/11-04-SUMMARY.md
@.planning/phases/09-gui-logic-visualization/09-01-SUMMARY.md
@.planning/phases/09-gui-logic-visualization/09-02-SUMMARY.md

# Existing patterns
@gui/js/components/causality-graph.js
@gui/js/screens/story-logic.js
@gui/js/api-client.js

# Database context
@db/modules/relationships.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create relationship-map.js Vis.js visualization component</name>
  <files>gui/js/components/relationship-map.js</files>
  <action>
Create Vis.js network graph component for character relationships. Follow patterns from causality-graph.js (D3 usage) but use Vis.js instead (load from CDN: https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js and CSS).

Structure:
- RelationshipMap object with render(containerId, fictionId) method
- Fetch relationship data via api.getRelationshipsFor(fictionId)
- Build Vis.js data structure: nodes array (entities), edges array (relationships)
- Color-code edges by relationship metrics:
  - Green (#2ecc71): High trust (trust_level > 0.7)
  - Red (#e74c3c): Fear/conflict (conflict_level > 0.5)
  - Blue (#3498db): Respect (trust_level 0.4-0.7)
  - Purple (#9b59b6): Power imbalance (abs(power_balance) > 0.5)
- Edge width based on intimacy_level (1-5px)
- Node labels show entity names
- Use Vis.js physics for force-directed layout (similar to Phase 9 causality graph force layout)
- Include hover tooltip showing detailed metrics (trust, power, sentiment, conflict)

Edge selection logic: Choose dominant relationship characteristic (trust > conflict > respect > power) for color.

Why Vis.js not D3: Vis.js has built-in network layouts optimized for relationship graphs, less code than D3 force simulation for this use case.
  </action>
  <verify>grep -q "vis.Network" gui/js/components/relationship-map.js && grep -q "getRelationshipsFor" gui/js/components/relationship-map.js</verify>
  <done>relationship-map.js exists, uses Vis.js Network, fetches relationship data, color-codes edges, shows tooltips</done>
</task>

<task type="auto">
  <name>Task 2: Create dashboard.js screen with v4.1 logic layer health stats</name>
  <files>gui/js/screens/dashboard.js</files>
  <action>
Create dashboard screen following existing screen patterns (timeline.js, story-logic.js structure).

Structure:
- DashboardScreen object with async render() method
- Screen header with title "Dashboard" and power drawer button
- Three stat widgets in grid layout:
  1. Unfired Setups Widget:
     - Fetch api.getUnfiredSetups(currentProjectId)
     - Display count with orange warning badge if count > 0
     - Label: "Unfired Setups (Chekhov's Guns)"
     - Click to navigate to story-logic screen, setup-payoffs tab

  2. Incomplete Arcs Widget:
     - Fetch api.getArcsForProject(currentProjectId)
     - Filter arcs where current_phase !== 'finale' (last phase in Save the Cat)
     - Display count of incomplete arcs
     - Label: "Incomplete Character Arcs"
     - Click to navigate to story-logic screen, arcs tab

  3. Unresolved Conflicts Widget:
     - Fetch api.getConflictsForProject(currentProjectId)
     - Filter conflicts where status !== 'resolved'
     - Display count of active/escalating/climactic conflicts
     - Label: "Unresolved Conflicts"
     - Click to navigate to story-logic screen, conflicts tab

- Use CSS Grid for responsive layout (similar to story-logic card grid)
- Each widget: card style with icon, count (large font), label, click handler
- Empty state: "Select a project to view stats" (check state.currentProjectId)

Why these stats: Surfacing unfired setups prevents abandoned Chekhov's guns. Incomplete arcs track character transformation progress. Unresolved conflicts show story tension that needs resolution. All align with "story health" theme.
  </action>
  <verify>grep -q "getUnfiredSetups\|getArcsForProject\|getConflictsForProject" gui/js/screens/dashboard.js && grep -q "async render()" gui/js/screens/dashboard.js</verify>
  <done>dashboard.js screen exists, fetches three stat types, displays widgets with counts, navigates to story-logic on click</done>
</task>

<task type="auto">
  <name>Task 3: Extend api-client.js with relationship endpoints and load Vis.js</name>
  <files>gui/js/api-client.js, gui/index.html</files>
  <action>
Add relationship methods to api-client.js following existing patterns (causality, arcs, conflicts sections):

```javascript
// Relationships section
async getRelationships(fictionId) {
  return this.request(`/api/relationships?fiction_id=${fictionId}`);
}

async getRelationshipsFor(entityId, fictionId, timestamp = null) {
  const timestampParam = timestamp ? `&timestamp=${timestamp}` : '';
  return this.request(`/api/relationships/entity/${entityId}?fiction_id=${fictionId}${timestampParam}`);
}

async getRelationshipBetween(entityAId, entityBId, fictionId, timestamp = null) {
  const timestampParam = timestamp ? `&timestamp=${timestamp}` : '';
  return this.request(`/api/relationships/between?entity_a=${entityAId}&entity_b=${entityBId}&fiction_id=${fictionId}${timestampParam}`);
}
```

Note: These endpoints may return stub responses if api/routes/entities.js hasn't implemented relationships yet. That's acceptable - the GUI component will handle empty arrays gracefully.

Also add Vis.js CDN script tag to gui/index.html in the libraries section (before D3.js line):
```html
<script src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
<link rel="stylesheet" href="https://unpkg.com/vis-network@9.1.2/dist/dist/vis-network.min.css" />
```
  </action>
  <verify>grep -q "getRelationshipsFor\|getRelationshipBetween" gui/js/api-client.js && grep -q "vis-network" gui/index.html</verify>
  <done>api-client.js has relationship methods, Vis.js loaded via CDN in index.html</done>
</task>

<task type="auto">
  <name>Task 4: Register dashboard in router and add navigation</name>
  <files>gui/js/app.js, gui/index.html</files>
  <action>
1. Load dashboard.js screen in gui/index.html scripts section (after story-logic.js):
   ```html
   <script src="/js/screens/dashboard.js"></script>
   ```

2. Register dashboard route in gui/js/app.js (after narrative line):
   ```javascript
   Router.register('dashboard', DashboardScreen);
   ```

3. Add nav link to sidebar in gui/index.html (add after Timeline link, before Epistemic):
   ```html
   <a href="#dashboard" class="nav-link" data-route="dashboard">
     <span class="nav-icon">ðŸ“Š</span>
     <span class="nav-label">Dashboard</span>
   </a>
   ```

4. Set dashboard as default route instead of timeline in router.js line 18 and 22:
   Change: `const initialRoute = window.location.hash.slice(1) || 'timeline';`
   To: `const initialRoute = window.location.hash.slice(1) || 'dashboard';`

Why dashboard as default: Dashboard provides overview of story health, natural landing page for authors. Timeline was temporary default during development.
  </action>
  <verify>grep -q "dashboard.js" gui/index.html && grep -q "Router.register('dashboard'" gui/js/app.js && grep -q "data-route=\"dashboard\"" gui/index.html</verify>
  <done>Dashboard screen loaded, registered in router, nav link added, set as default route</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] npm run build succeeds (no TypeScript errors, though project uses vanilla JS)
- [ ] Vis.js library loads without console errors
- [ ] Dashboard screen renders with three stat widgets
- [ ] Relationship map component defined (may show empty state if no relationship data)
- [ ] API client has relationship methods
- [ ] Dashboard registered in router and accessible via navigation
</verification>

<success_criteria>
- All tasks completed
- relationship-map.js component exists and uses Vis.js
- dashboard.js screen exists with three v4.1 stat widgets
- api-client.js extended with relationship endpoints
- Dashboard registered in router and set as default route
- Vis.js library loaded via CDN
- All files build/load without errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-gui-advanced-features/12-01-SUMMARY.md`
</output>
