---
phase: 07-api-layer
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - api/routes/logic-layer.js
autonomous: true

must_haves:
  truths:
    - "User can create thematic elements via POST /api/logic/themes"
    - "User can query themes via GET /api/logic/themes/:id"
    - "User can create motif instances via POST /api/logic/motifs"
    - "User can query motifs by type via GET /api/logic/motifs/type/:type"
    - "User can create setup/payoffs via POST /api/logic/setup-payoffs"
    - "User can query unfired setups via GET /api/logic/setup-payoffs/unfired"
    - "User can create world rules via POST /api/logic/world-rules"
    - "User can query world rules by category via GET /api/logic/world-rules/category/:category"
  artifacts:
    - path: "api/routes/logic-layer.js"
      provides: "REST endpoints for themes, motifs, setup-payoffs, world-rules"
      min_lines: 250
  key_links:
    - from: "POST /api/logic/themes"
      to: "api.thematicElements.createTheme"
      via: "facade method call"
    - from: "GET /api/logic/setup-payoffs/unfired"
      to: "api.setupPayoffs.getUnfiredSetups"
      via: "specialized query"
---

<objective>
Add remaining logic layer REST endpoints for themes, motifs, setup/payoffs, and world rules.

Purpose: Complete logic layer API exposure, enabling full story structure manipulation via HTTP.
Output: Logic layer route with all 7 module endpoints operational.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Existing work from Plan 01
@.planning/phases/07-api-layer/07-01-PLAN.md

# Database facade with all logic layer modules
@db/api-functions.js

# Reference for module patterns
@db/modules/thematic-elements.js
@db/modules/motif-instances.js
@db/modules/setup-payoffs.js
@db/modules/world-rules.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add thematic elements and motif instances endpoints</name>
  <files>api/routes/logic-layer.js</files>
  <action>
Add to existing logic-layer.js file (below conflict endpoints):

**Thematic Elements Endpoints:**

- **POST /api/logic/themes** - Create thematic element
  - Body: `{ project_id, statement, primary_symbol_id, question, manifestations }`
  - Validation: require project_id, statement
  - Note: manifestations is optional JSON array, pass as-is to module
  - Call: `api.thematicElements.createTheme(...)`
  - Response: 201 with created theme object

- **GET /api/logic/themes/:themeId** - Get single theme
  - Call: `api.thematicElements.getThemeById(themeId)`
  - Response: 200 with theme object or 404 if not found

- **GET /api/logic/themes/project/:projectId** - Get all themes for project
  - Call: `api.thematicElements.getThemesByProject(projectId)`
  - Response: 200 with array of themes

- **PUT /api/logic/themes/:themeId** - Update theme
  - Body: updates object (any fields except theme_uuid, project_id)
  - Call: `api.thematicElements.updateTheme(themeId, updates)`
  - Response: 200 with updated theme or 404 if not found

- **POST /api/logic/themes/:themeId/manifestations** - Add manifestation to theme
  - Body: `{ manifestation }` (string describing how theme appears)
  - Call: `api.thematicElements.addManifestation(themeId, manifestation)`
  - Response: 200 with updated theme

- **DELETE /api/logic/themes/:themeId/manifestations/:manifestation** - Remove manifestation
  - URL param: manifestation (URL-encoded string to remove)
  - Call: `api.thematicElements.removeManifestation(themeId, decodeURIComponent(manifestation))`
  - Response: 200 with updated theme

- **DELETE /api/logic/themes/:themeId** - Delete theme
  - Call: `api.thematicElements.deleteTheme(themeId)`
  - Response: 204 no content or 404 if not found

**Motif Instance Endpoints:**

- **POST /api/logic/motifs** - Create motif instance
  - Body: `{ project_id, motif_type, linked_entity_id, description, significance }`
  - Validation: require project_id, motif_type, validate motif_type enum (visual|auditory|symbolic|narrative_pattern|recurring_phrase)
  - Call: `api.motifInstances.createMotif(...)`
  - Response: 201 with created motif object

- **GET /api/logic/motifs/:motifId** - Get single motif
  - Call: `api.motifInstances.getMotifById(motifId)`
  - Response: 200 with motif object or 404 if not found

- **GET /api/logic/motifs/type/:type** - Get all motifs of specific type
  - Call: `api.motifInstances.getMotifInstancesByType(type)`
  - Response: 200 with array of motifs

- **GET /api/logic/motifs/project/:projectId** - Get all motifs for project
  - Call: `api.motifInstances.getMotifsByProject(projectId)`
  - Response: 200 with array of motifs

- **PUT /api/logic/motifs/:motifId** - Update motif
  - Body: updates object (any fields except motif_uuid, project_id)
  - Call: `api.motifInstances.updateMotif(motifId, updates)`
  - Response: 200 with updated motif or 404 if not found

- **DELETE /api/logic/motifs/:motifId** - Delete motif
  - Call: `api.motifInstances.deleteMotif(motifId)`
  - Response: 204 no content or 404 if not found

**Error handling:** Same pattern as existing endpoints - try/catch with next(err).
  </action>
  <verify>
Thematic elements endpoints exist (7 total: POST, GET single, GET by project, PUT, POST add manifestation, DELETE manifestation, DELETE). Motif instances endpoints exist (6 total: POST, GET single, GET by type, GET by project, PUT, DELETE). All follow established error handling pattern.
  </verify>
  <done>
Themes and motifs endpoints complete. Logic layer route now covers 4 of 7 modules.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add setup/payoff and world rules endpoints</name>
  <files>api/routes/logic-layer.js</files>
  <action>
Add to existing logic-layer.js file (below motif endpoints):

**Setup/Payoff Endpoints:**

- **POST /api/logic/setup-payoffs** - Create setup/payoff
  - Body: `{ project_id, setup_event_id, payoff_event_id, description, status, planted_chapter, fired_chapter }`
  - Validation: require project_id, setup_event_id, description, validate status enum (planted|referenced|fired) if provided (default: 'planted')
  - Call: `api.setupPayoffs.createSetup(...)`
  - Response: 201 with created setup object

- **GET /api/logic/setup-payoffs/:setupId** - Get single setup/payoff
  - Call: `api.setupPayoffs.getSetupById(setupId)`
  - Response: 200 with setup object or 404 if not found

- **GET /api/logic/setup-payoffs/project/:projectId** - Get all setups for project
  - Call: `api.setupPayoffs.getSetupsByProject(projectId)`
  - Response: 200 with array of setups

- **GET /api/logic/setup-payoffs/unfired** - Get unfired setups (Chekhov's gun tracker)
  - Query param: `project_id` (required)
  - Validation: require project_id query param
  - Call: `api.setupPayoffs.getUnfiredSetups(req.query.project_id)`
  - Response: 200 with array of setups with status 'planted' or 'referenced' but not 'fired'

- **POST /api/logic/setup-payoffs/:setupId/fire** - Fire setup (helper endpoint)
  - Body: `{ payoff_event_id, fired_chapter }`
  - Validation: require payoff_event_id, fired_chapter
  - Call: `api.setupPayoffs.fireSetup(setupId, payoff_event_id, fired_chapter)`
  - Response: 200 with updated setup showing status='fired'

- **PUT /api/logic/setup-payoffs/:setupId** - Update setup
  - Body: updates object (any fields except setup_uuid, project_id, setup_event_id)
  - Call: `api.setupPayoffs.updateSetup(setupId, updates)`
  - Response: 200 with updated setup or 404 if not found

- **DELETE /api/logic/setup-payoffs/:setupId** - Delete setup
  - Call: `api.setupPayoffs.deleteSetup(setupId)`
  - Response: 204 no content or 404 if not found

**World Rules Endpoints:**

- **POST /api/logic/world-rules** - Create world rule
  - Body: `{ project_id, rule_category, statement, exceptions, enforcement_level }`
  - Validation: require project_id, rule_category, statement, validate rule_category enum (physics|magic|technology|social|biological|metaphysical), validate enforcement_level enum (strict|flexible|guideline) if provided (default: 'strict')
  - Call: `api.worldRules.createRule(...)`
  - Response: 201 with created rule object

- **GET /api/logic/world-rules/:ruleId** - Get single rule
  - Call: `api.worldRules.getRuleById(ruleId)`
  - Response: 200 with rule object or 404 if not found

- **GET /api/logic/world-rules/category/:category** - Get all rules in category
  - Call: `api.worldRules.getRulesByCategory(category)`
  - Response: 200 with array of rules

- **GET /api/logic/world-rules/project/:projectId** - Get all rules for project
  - Call: `api.worldRules.getRulesByProject(projectId)`
  - Response: 200 with array of rules

- **PUT /api/logic/world-rules/:ruleId** - Update rule
  - Body: updates object (any fields except rule_uuid, project_id, rule_category which is immutable)
  - Note: rule_category is immutable per module design (physics rule can't become magic rule)
  - Call: `api.worldRules.updateRule(ruleId, updates)`
  - Response: 200 with updated rule or 404 if not found

- **DELETE /api/logic/world-rules/:ruleId** - Delete rule
  - Call: `api.worldRules.deleteRule(ruleId)`
  - Response: 204 no content or 404 if not found

**Consistency:** All endpoints follow same validation, error handling, and response patterns as previous endpoints.
  </action>
  <verify>
Setup/payoff endpoints exist (7 total: POST, GET single, GET by project, GET unfired, POST fire, PUT, DELETE). World rules endpoints exist (6 total: POST, GET single, GET by category, GET by project, PUT, DELETE). All endpoints use facade pattern and proper error handling.
  </verify>
  <done>
All 7 logic layer modules now have REST endpoints. Logic layer route complete with ~43 total endpoints covering causality chains, character arcs, story conflicts, thematic elements, motif instances, setup/payoffs, and world rules.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Thematic elements endpoints exist (7 endpoints)
- [ ] Motif instances endpoints exist (6 endpoints)
- [ ] Setup/payoff endpoints exist (7 endpoints including /unfired and /fire helpers)
- [ ] World rules endpoints exist (6 endpoints)
- [ ] All endpoints follow established patterns (try/catch, facade usage, standard responses)
- [ ] Specialized queries implemented (unfired setups, motifs by type, rules by category)
- [ ] Helper endpoints implemented (fire setup, add/remove manifestations, advance arc phase from Plan 01)
</verification>

<success_criteria>
- All tasks completed
- All 7 logic layer modules have REST API exposure
- Specialized query endpoints operational (unfired setups, type filters, category filters)
- Helper endpoints operational (fire, advance, add/remove)
- Code quality consistent with Plan 01
</success_criteria>

<output>
After completion, create `.planning/phases/07-api-layer/07-02-SUMMARY.md`
</output>
