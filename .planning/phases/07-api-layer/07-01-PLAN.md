---
phase: 07-api-layer
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/routes/logic-layer.js
  - api/server.js
autonomous: true

must_haves:
  truths:
    - "User can create causality chains via POST /api/logic/causality"
    - "User can query causality chains via GET /api/logic/causality/:id"
    - "User can traverse causal graphs via GET /api/logic/causality/chain/:eventId with depth parameter"
    - "User can create character arcs via POST /api/logic/arcs"
    - "User can update character arcs via PUT /api/logic/arcs/:id"
    - "User can create story conflicts via POST /api/logic/conflicts"
    - "User can query story conflicts via GET /api/logic/conflicts/:id"
  artifacts:
    - path: "api/routes/logic-layer.js"
      provides: "REST endpoints for causality, arcs, conflicts"
      min_lines: 150
    - path: "api/server.js"
      provides: "/api/logic route registration"
      contains: "logic-layer"
  key_links:
    - from: "api/routes/logic-layer.js"
      to: "db/api-functions"
      via: "createAPI facade import"
      pattern: "require.*api-functions"
    - from: "api/server.js"
      to: "api/routes/logic-layer.js"
      via: "route registration"
      pattern: "app\\.use.*\\/api\\/logic"
---

<objective>
Create core logic layer REST endpoints for causality chains, character arcs, and story conflicts.

Purpose: Expose first wave of logic layer functionality via HTTP, enabling GUI and AI agents to manipulate story structure.
Output: Working /api/logic route with CRUD endpoints for causality, arcs, and conflicts.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Codebase context
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

# Prior work
@.planning/phases/06-logic-layer-integration/06-01-SUMMARY.md

# Existing route pattern
@api/routes/moments.js

# Database facade providing access to logic layer modules
@db/api-functions.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create api/routes/logic-layer.js with causality endpoints</name>
  <files>api/routes/logic-layer.js</files>
  <action>
Create new Express router module following the established pattern (see moments.js):

1. **File header:** JSDoc comment describing logic layer REST endpoints
2. **Imports:**
   - `const express = require('express');`
   - `const createAPI = require('../../db/api-functions');`
3. **Module export:** `module.exports = (db) => { const router = express.Router(); ... return router; }`
4. **Facade initialization:** `const api = createAPI(db);` inside module function

**Causality Chain Endpoints:**

- **POST /api/logic/causality** - Create causal chain
  - Body: `{ cause_event_id, effect_event_id, type, strength, explanation }`
  - Validation: require cause_event_id, effect_event_id, type (direct_cause|enabling_condition|motivation|psychological_trigger)
  - Call: `api.causalityChains.createChain(...)`
  - Response: 201 with created chain object

- **GET /api/logic/causality/:chainId** - Get single chain by ID
  - Call: `api.causalityChains.getChainById(chainId)`
  - Response: 200 with chain object or 404 if not found

- **GET /api/logic/causality/chain/:eventId** - Get full causal graph for event
  - Query param: `depth` (default: 3, max: 10)
  - Call: `api.causalityChains.traverseChain(eventId, depth)`
  - Response: 200 with graph object (nodes and edges arrays)

- **PUT /api/logic/causality/:chainId** - Update chain
  - Body: updates object (strength, explanation only - type is immutable per module)
  - Call: `api.causalityChains.updateChain(chainId, updates)`
  - Response: 200 with updated chain or 404 if not found

- **DELETE /api/logic/causality/:chainId** - Delete chain
  - Call: `api.causalityChains.deleteChain(chainId)`
  - Response: 204 no content or 404 if not found

**Error handling:** Wrap all handlers in try/catch, call `next(err)` for Express error middleware.

**Validation:** Check required fields, return 400 with clear error messages. Validate depth parameter (1-10 range).
  </action>
  <verify>
File exists at api/routes/logic-layer.js with causality endpoints. Code follows established patterns from moments.js (factory function, router returned, facade usage). All 5 causality endpoints defined (POST, GET single, GET chain, PUT, DELETE).
  </verify>
  <done>
Causality chain endpoints implemented and ready for testing. File structure matches existing route conventions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add character arc and story conflict endpoints</name>
  <files>api/routes/logic-layer.js</files>
  <action>
Add to the same logic-layer.js file (below causality endpoints):

**Character Arc Endpoints:**

- **POST /api/logic/arcs** - Create character arc
  - Body: `{ character_id, archetype, lie_belief, truth_belief, want_external, need_internal, current_phase }`
  - Validation: require character_id, validate current_phase enum (setup|catalyst|debate|midpoint|all_is_lost|finale)
  - Call: `api.characterArcs.createArc(...)`
  - Response: 201 with created arc object

- **GET /api/logic/arcs/character/:characterId** - Get arc by character ID
  - Call: `api.characterArcs.getArcByCharacter(characterId)`
  - Response: 200 with arc object or 404 if not found

- **GET /api/logic/arcs/:arcId** - Get arc by arc ID
  - Call: `api.characterArcs.getArcById(arcId)`
  - Response: 200 with arc object or 404 if not found

- **PUT /api/logic/arcs/:arcId** - Update arc
  - Body: updates object (any arc fields except character_id which is immutable)
  - Call: `api.characterArcs.updateArc(arcId, updates)`
  - Response: 200 with updated arc or 404 if not found

- **POST /api/logic/arcs/:arcId/advance** - Advance arc phase (helper endpoint)
  - Call: `api.characterArcs.advancePhase(arcId)`
  - Response: 200 with updated arc showing next phase

- **DELETE /api/logic/arcs/:arcId** - Delete arc
  - Call: `api.characterArcs.deleteArc(arcId)`
  - Response: 204 no content or 404 if not found

**Story Conflict Endpoints:**

- **POST /api/logic/conflicts** - Create story conflict
  - Body: `{ project_id, type, protagonist_id, antagonist_source, stakes_success, stakes_fail, status }`
  - Validation: require project_id, type, protagonist_id, validate type enum (internal|interpersonal|societal|environmental|supernatural), validate status enum (latent|active|escalating|climactic|resolved)
  - Call: `api.storyConflicts.createConflict(...)`
  - Response: 201 with created conflict object

- **GET /api/logic/conflicts/:conflictId** - Get single conflict
  - Call: `api.storyConflicts.getConflictById(conflictId)`
  - Response: 200 with conflict object or 404 if not found

- **GET /api/logic/conflicts/project/:projectId** - Get all conflicts for project
  - Call: `api.storyConflicts.getConflictsByProject(projectId)`
  - Response: 200 with array of conflicts

- **PUT /api/logic/conflicts/:conflictId** - Update conflict
  - Body: updates object (any fields except conflict_uuid, project_id, protagonist_id which are immutable)
  - Call: `api.storyConflicts.updateConflict(conflictId, updates)`
  - Response: 200 with updated conflict or 404 if not found

- **POST /api/logic/conflicts/:conflictId/transition** - Transition conflict status
  - Body: `{ new_status }` (latent|active|escalating|climactic|resolved)
  - Call: `api.storyConflicts.transitionConflictStatus(conflictId, new_status)`
  - Response: 200 with updated conflict

- **DELETE /api/logic/conflicts/:conflictId** - Delete conflict
  - Call: `api.storyConflicts.deleteConflict(conflictId)`
  - Response: 204 no content or 404 if not found

**Pattern consistency:** All endpoints follow same error handling, validation, and response format as causality endpoints.
  </action>
  <verify>
Character arc endpoints exist (6 total: POST, GET by char, GET by ID, PUT, POST advance, DELETE). Story conflict endpoints exist (6 total: POST, GET single, GET by project, PUT, POST transition, DELETE). All follow established patterns.
  </verify>
  <done>
Character arc and story conflict REST endpoints complete. Logic layer route file now has 17 endpoints across 3 modules.
  </done>
</task>

<task type="auto">
  <name>Task 3: Register logic layer route in server.js</name>
  <files>api/server.js</files>
  <action>
Enhance api/server.js to register the new logic layer route:

1. **Import logic layer route:** Add below existing route imports (after orchestratorRoutes line):
   ```javascript
   const logicLayerRoutes = require('./routes/logic-layer');
   ```

2. **Register route:** Add below existing route registrations (after orchestrator route):
   ```javascript
   app.use('/api/logic', logicLayerRoutes(db));
   ```

**Placement:** Keep imports grouped together, keep route registrations grouped together. Maintain existing comment structure if present. Don't modify error handling middleware or health check endpoint.

**Verification:** Server should load without errors, /api/logic route should be accessible.
  </action>
  <verify>
Server.js imports logic-layer route module and registers /api/logic with Express app. Pattern matches existing route registrations (state, epistemic, moments, orchestrator).
  </verify>
  <done>
Logic layer route registered in server.js. API now exposes causality, arcs, and conflicts endpoints at /api/logic/*.
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] api/routes/logic-layer.js exists with all 17 endpoints (5 causality, 6 arcs, 6 conflicts)
- [ ] server.js imports and registers logic-layer route
- [ ] Code follows established conventions (kebab-case files, camelCase functions, try/catch error handling)
- [ ] All endpoints use facade pattern (createAPI(db))
- [ ] Manual test: curl POST /api/logic/causality returns 201 (or 400 if validation fails)
</verification>

<success_criteria>
- All tasks completed
- Logic layer route exists and is registered
- Causality, arcs, and conflicts endpoints operational
- Code quality matches existing route files
- No errors when starting server
</success_criteria>

<output>
After completion, create `.planning/phases/07-api-layer/07-01-SUMMARY.md`
</output>
