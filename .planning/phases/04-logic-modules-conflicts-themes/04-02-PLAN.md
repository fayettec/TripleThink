---
phase: 04-logic-modules-conflicts-themes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [db/modules/thematic-elements.js]
autonomous: true

# Goal-backward verification
must_haves:
  truths:
    - "User can create thematic elements with statements and questions"
    - "User can link themes to symbolic entities (optional)"
    - "User can track theme manifestations (JSON array)"
    - "Theme module provides full CRUD operations for theme tracking"
  artifacts:
    - path: "db/modules/thematic-elements.js"
      provides: "Thematic element CRUD operations for consistency tracking"
      min_lines: 80
      exports: ["createTheme", "getThemesByProject", "getThemeById", "updateTheme", "deleteTheme"]
  key_links:
    - from: "thematic-elements.js createTheme"
      to: "THEMATIC_ELEMENTS table"
      via: "INSERT prepared statement"
      pattern: "db\\.prepare.*INSERT INTO thematic_elements"
    - from: "thematic-elements.js updateTheme"
      to: "THEMATIC_ELEMENTS table manifestations field"
      via: "UPDATE with JSON array serialization"
      pattern: "UPDATE thematic_elements SET"
---

<objective>
Create complete thematic-elements.js module with CRUD operations for theme tracking.

Purpose: Enable tracking of thematic statements, questions, symbols, and how themes manifest throughout the story. Supports thematic consistency analysis and layered storytelling.

Output: Working database module following established patterns, with comprehensive self-tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries (patterns established)
@.planning/phases/03-logic-layer-modules-causality-arcs/03-01-SUMMARY.md
@.planning/phases/03-logic-layer-modules-causality-arcs/03-02-SUMMARY.md

# Database schema reference
@db/migrations/006_logic_layer.sql

# Codebase conventions
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create thematic-elements.js with CRUD operations</name>
  <files>db/modules/thematic-elements.js</files>
  <action>
    Create db/modules/thematic-elements.js following the module factory pattern.

    **Module structure:**
    - Module factory: function taking db parameter, returns object with methods
    - Import better-sqlite3 for type hints only (Database type)
    - JSDoc comments for all exported functions

    **Implement 5 CRUD functions:**

    1. **createTheme({ project_id, statement, primary_symbol_id = null, question = null, manifestations = [] })**
       - Generate theme_uuid using crypto.randomUUID()
       - Serialize manifestations array to JSON string: JSON.stringify(manifestations)
       - Use Date.now() for created_at
       - INSERT prepared statement
       - Return created theme object with deserialized manifestations (JSON.parse back to array)
       - statement is required, other fields optional

    2. **getThemesByProject(project_id)**
       - SELECT all themes for project
       - Deserialize manifestations JSON for each theme (JSON.parse or return empty array if null)
       - Return array of theme objects (empty array if none)

    3. **getThemeById(theme_uuid)**
       - SELECT single theme by UUID
       - Deserialize manifestations JSON
       - Return theme object or null if not found

    4. **updateTheme(theme_uuid, updates)**
       - Dynamic UPDATE with validated fields
       - Allowed fields: statement, primary_symbol_id, question, manifestations
       - Immutable fields: theme_uuid, project_id, created_at
       - If updates contains manifestations, serialize to JSON string before UPDATE
       - Return updated row count (1 if successful, 0 if not found)

    5. **deleteTheme(theme_uuid)**
       - DELETE by UUID
       - Return boolean (true if deleted, false if not found)

    **JSON handling notes:**
    - manifestations stored as TEXT in database (SQLite has no native JSON type)
    - Always serialize arrays to JSON on write: JSON.stringify(manifestations)
    - Always deserialize JSON to arrays on read: JSON.parse(row.manifestations) || []
    - Handle null manifestations gracefully (return empty array)

    **Example manifestations array:**
    ```javascript
    [
      "Recurring water imagery represents emotional depth",
      "Protagonist's lie belief manifests in self-sabotage",
      "Antagonist embodies the thematic question's dark answer"
    ]
    ```
  </action>
  <verify>
    Module file exists at db/modules/thematic-elements.js
    Functions export correctly
    No syntax errors (node --check db/modules/thematic-elements.js)
  </verify>
  <done>
    thematic-elements.js module created with 5 CRUD functions
    JSON serialization/deserialization implemented for manifestations
    Module follows established patterns from Phase 3
  </done>
</task>

<task type="auto">
  <name>Task 2: Add helper for adding/removing manifestations</name>
  <files>db/modules/thematic-elements.js</files>
  <action>
    Add 2 helper functions for managing theme manifestations (6th and 7th exported functions).

    **1. addManifestation(theme_uuid, manifestation_text)**
    - Get current theme by theme_uuid
    - Return 0 if theme not found
    - Append manifestation_text to manifestations array
    - Update theme with new manifestations array
    - Return 1 if successful

    **2. removeManifestation(theme_uuid, index)**
    - Get current theme by theme_uuid
    - Return 0 if theme not found or index out of bounds
    - Remove manifestation at specified index using Array.splice()
    - Update theme with modified manifestations array
    - Return 1 if successful

    **Purpose:**
    Convenience functions for GUI to add/remove manifestations without fetching, modifying, and updating entire theme object.

    **Implementation notes:**
    - Both functions use getThemeById and updateTheme internally
    - Manifestation text should be non-empty string (validate before adding)
    - Index validation: 0 <= index < manifestations.length
  </action>
  <verify>
    addManifestation and removeManifestation functions exist and are exported
    Functions validate inputs before modifying arrays
  </verify>
  <done>
    Helper functions added for manifestation management
    GUI can add/remove manifestations without full theme update
    Functions reuse existing CRUD operations internally
  </done>
</task>

<task type="auto">
  <name>Task 3: Add comprehensive self-test for thematic-elements module</name>
  <files>db/modules/thematic-elements.js</files>
  <action>
    Add self-test at bottom of module following the established pattern.

    **Pattern:**
    ```javascript
    if (require.main === module) {
      // Self-test code here
    }
    ```

    **Test structure:**
    1. Create in-memory SQLite database
    2. Run 006_logic_layer.sql migration to create THEMATIC_ELEMENTS table
    3. Initialize module with test database
    4. Run assertions covering all 7 functions

    **Test cases (10+ assertions):**

    1. **createTheme - with statement only**
       - Create theme with just statement field
       - Assert theme object returned with theme_uuid
       - Assert manifestations defaults to empty array

    2. **createTheme - with all fields**
       - Create theme with statement, question, primary_symbol_id, and 2 manifestations
       - Assert all fields persisted correctly
       - Assert manifestations is array (not JSON string)

    3. **getThemesByProject**
       - Create 2 themes for project 'proj1'
       - Assert getThemesByProject('proj1') returns array of length 2
       - Assert manifestations deserialized correctly for both themes

    4. **getThemeById**
       - Retrieve theme by UUID
       - Assert returned object matches created theme
       - Assert manifestations is array (not JSON string)

    5. **updateTheme - update statement**
       - Update statement field
       - Assert change persisted
       - Verify manifestations unchanged

    6. **updateTheme - update manifestations**
       - Update manifestations array to add new item
       - Assert new array persisted
       - Assert JSON serialization/deserialization works

    7. **addManifestation**
       - Use addManifestation to add new manifestation text
       - Assert manifestations array grows by 1
       - Assert new text appears at end of array

    8. **addManifestation - theme not found**
       - Try adding manifestation to non-existent theme_uuid
       - Assert returns 0 (not found)

    9. **removeManifestation**
       - Create theme with 3 manifestations
       - Remove manifestation at index 1
       - Assert array length is 2
       - Assert correct manifestation removed

    10. **removeManifestation - invalid index**
        - Try removing at index 999 (out of bounds)
        - Assert returns 0 (invalid index)

    11. **deleteTheme**
        - Delete theme by UUID
        - Assert returns true
        - Assert getThemeById returns null

    12. **Empty manifestations handling**
        - Create theme with manifestations=null/undefined
        - Assert getThemeById returns theme with empty array (not null)

    **Output format:**
    - Print "thematic-elements.js self-test..." at start
    - Print "✓ Test N: description" for each passing assertion
    - Print "✗ Test N failed: error" if any fail
    - Print "All tests passed!" at end if successful
  </action>
  <verify>
    Run self-test: node db/modules/thematic-elements.js
    All 10+ assertions pass
    JSON serialization works correctly in both directions
  </verify>
  <done>
    Comprehensive self-test covers all 7 exported functions
    Tests validate JSON handling for manifestations array
    Self-test can be run standalone for verification
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] thematic-elements.js module exists with 7 exported functions (5 CRUD + 2 helpers)
- [ ] JSON serialization/deserialization works for manifestations array
- [ ] Self-test runs successfully: `node db/modules/thematic-elements.js`
- [ ] Module can be imported by other modules (no syntax errors)
- [ ] Pattern matches established modules (causality-chains.js, character-arcs.js, story-conflicts.js)
</verification>

<success_criteria>
- All tasks completed with atomic commits
- thematic-elements.js module functional and tested
- JSON array handling works correctly for manifestations field
- Helper functions simplify manifestation management
- Self-test demonstrates full functionality
- Module ready for Phase 6 integration and Phase 7 API exposure
</success_criteria>

<output>
After completion, create `.planning/phases/04-logic-modules-conflicts-themes/04-02-SUMMARY.md`
</output>
