---
phase: 03-logic-layer-modules-causality-arcs
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [db/modules/character-arcs.js]
autonomous: true

must_haves:
  truths:
    - "User can create character arc with lie/truth, want/need, archetype, and current phase"
    - "User can retrieve character arcs by project"
    - "User can retrieve character arc by character ID"
    - "User can update arc phase as character progresses through Save the Cat beats"
    - "All 13 Save the Cat phases are tracked (setup through final_image)"
  artifacts:
    - path: "db/modules/character-arcs.js"
      provides: "CRUD operations for character arcs"
      min_lines: 120
      exports: ["createArc", "getArcsByProject", "getArcByCharacter", "getArcById", "updateArc", "deleteArc"]
  key_links:
    - from: "db/modules/character-arcs.js"
      to: "character_arcs table"
      via: "SQL prepared statements"
      pattern: "db\\.prepare.*character_arcs"
---

<objective>
Implement character-arcs.js module with full CRUD operations and Save the Cat phase tracking.

Purpose: Enable tracking of character transformation arcs following Blake Snyder's Save the Cat beat structure, capturing lie/truth beliefs, want/need dynamics, and narrative arc progress.
Output: Working database module exposing character arc tracking functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries
@.planning/phases/02-logic-layer-schema/02-01-SUMMARY.md
@.planning/phases/03-logic-layer-modules-causality-arcs/03-01-SUMMARY.md

# Existing patterns to follow
@db/modules/event-moments.js
@db/modules/causality-chains.js
@db/migrations/006_logic_layer.sql

# Codebase architecture
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create character-arcs.js with CRUD operations</name>
  <files>db/modules/character-arcs.js</files>
  <action>
Create db/modules/character-arcs.js following the module pattern from event-moments.js and causality-chains.js:

1. Module exports function that takes db parameter and returns object with exported functions
2. Import uuid: `const { v4: uuidv4 } = require('uuid');`
3. Implement CRUD functions:
   - `createArc(projectId, characterId, archetype, lieBelief, truthBelief, wantExternal, needInternal, currentPhase = 'setup')` - Creates new arc with UUID, validates phase enum, returns arc object. All text fields can be null except projectId, characterId, currentPhase.
   - `getArcsByProject(projectId)` - Returns all arcs for a project
   - `getArcByCharacter(characterId)` - Returns arc for specific character (1:1 relationship - character has one arc)
   - `getArcById(arcUuid)` - Returns single arc or null
   - `updateArc(arcUuid, updates)` - Updates allowed fields (archetype, lieBelief, truthBelief, wantExternal, needInternal, currentPhase), returns updated arc or null
   - `deleteArc(arcUuid)` - Deletes arc, returns true/false
4. Use prepared statements for all queries: `db.prepare(sql).run/get/all(params)`
5. Follow snake_case for database columns, camelCase for parameters
6. Include JSDoc comments for each function explaining parameters and return values
7. Validate currentPhase enum: ['setup', 'catalyst', 'debate', 'break_into_two', 'b_story', 'fun_and_games', 'midpoint', 'bad_guys_close_in', 'all_is_lost', 'dark_night_of_soul', 'break_into_three', 'finale', 'final_image']

Schema reference (from 006_logic_layer.sql):
- arc_uuid TEXT PRIMARY KEY
- project_id TEXT NOT NULL
- character_id TEXT NOT NULL (references entities where entity_type='character')
- archetype TEXT (nullable - e.g., 'hero', 'mentor', 'shadow', 'trickster')
- lie_belief TEXT (nullable - false belief character holds at story start)
- truth_belief TEXT (nullable - truth character must learn)
- want_external TEXT (nullable - external goal character pursues)
- need_internal TEXT (nullable - internal need character must fulfill)
- current_phase TEXT CHECK(current_phase IN (...13 Save the Cat phases...))
- created_at INTEGER NOT NULL

Note: Unlike causality chains where all fields are required, character arcs allow null for most fields since authors may not define all aspects upfront.
  </action>
  <verify>node -e "const m = require('./db/modules/character-arcs.js'); console.log(Object.keys(m({ prepare: () => ({}) })))"</verify>
  <done>Module exports createArc, getArcsByProject, getArcByCharacter, getArcById, updateArc, deleteArc functions</done>
</task>

<task type="auto">
  <name>Task 2: Add phase progression helper function</name>
  <files>db/modules/character-arcs.js</files>
  <action>
Add helper function to character-arcs.js module for phase progression:

**Function signature:**
```javascript
const advancePhase = (arcUuid) => {
  // Advances character to next Save the Cat phase
}
```

**Implementation:**
1. Define phase order array:
```javascript
const PHASE_ORDER = [
  'setup',
  'catalyst',
  'debate',
  'break_into_two',
  'b_story',
  'fun_and_games',
  'midpoint',
  'bad_guys_close_in',
  'all_is_lost',
  'dark_night_of_soul',
  'break_into_three',
  'finale',
  'final_image'
];
```
2. Get current arc by arcUuid
3. Find current phase index in PHASE_ORDER
4. If already at 'final_image', return arc unchanged (no advancement possible)
5. Increment index, get next phase
6. Update arc with new current_phase
7. Return updated arc

**Purpose:**
- Simplifies phase progression for common case (sequential advancement)
- GUI can call this when user clicks "Advance to Next Phase" button
- Authors can still manually set phase via updateArc for non-linear progressions

**Export this function along with the main CRUD functions.**
  </action>
  <verify>node -e "const db = require('better-sqlite3')(':memory:'); const m = require('./db/modules/character-arcs.js')(db); console.log(typeof m.advancePhase)"</verify>
  <done>advancePhase function exists, advances phase sequentially, returns updated arc</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for character-arcs module</name>
  <files>db/modules/character-arcs.js</files>
  <action>
Add inline validation and basic smoke test at bottom of character-arcs.js:

**If module is run directly (not imported), execute self-test:**
```javascript
if (require.main === module) {
  const Database = require('better-sqlite3');
  const testDb = new Database(':memory:');

  // Create table
  testDb.exec(`
    CREATE TABLE character_arcs (
      arc_uuid TEXT PRIMARY KEY,
      project_id TEXT NOT NULL,
      character_id TEXT NOT NULL,
      archetype TEXT,
      lie_belief TEXT,
      truth_belief TEXT,
      want_external TEXT,
      need_internal TEXT,
      current_phase TEXT CHECK(current_phase IN (
        'setup', 'catalyst', 'debate', 'break_into_two', 'b_story',
        'fun_and_games', 'midpoint', 'bad_guys_close_in', 'all_is_lost',
        'dark_night_of_soul', 'break_into_three', 'finale', 'final_image'
      )),
      created_at INTEGER NOT NULL
    )
  `);

  const module = require('./character-arcs')(testDb);

  // Test 1: Create arc
  const arc = module.createArc(
    'proj-001',
    'char-alice',
    'hero',
    'She believes she is powerless',
    'She has power within',
    'Wants to find her parents',
    'Needs to believe in herself',
    'setup'
  );
  console.assert(arc.character_id === 'char-alice', 'Arc character should be char-alice');
  console.assert(arc.current_phase === 'setup', 'Arc phase should be setup');

  // Test 2: Retrieve by project
  const byProject = module.getArcsByProject('proj-001');
  console.assert(byProject.length === 1, 'Should find 1 arc by project');

  // Test 3: Retrieve by character
  const byChar = module.getArcByCharacter('char-alice');
  console.assert(byChar !== null, 'Should find arc for char-alice');
  console.assert(byChar.archetype === 'hero', 'Archetype should be hero');

  // Test 4: Advance phase
  const advanced = module.advancePhase(arc.arc_uuid);
  console.assert(advanced.current_phase === 'catalyst', 'Phase should advance to catalyst');

  // Test 5: Advance again
  const advanced2 = module.advancePhase(arc.arc_uuid);
  console.assert(advanced2.current_phase === 'debate', 'Phase should advance to debate');

  // Test 6: Update arc fields
  const updated = module.updateArc(arc.arc_uuid, {
    want_external: 'Wants to save the kingdom',
    archetype: 'reluctant_hero'
  });
  console.assert(updated.want_external === 'Wants to save the kingdom', 'Want should be updated');
  console.assert(updated.archetype === 'reluctant_hero', 'Archetype should be updated');

  console.log('✓ All character-arcs module tests passed');
}
```

Run self-test with: `node db/modules/character-arcs.js`
  </action>
  <verify>node db/modules/character-arcs.js</verify>
  <done>Self-test passes, prints "✓ All character-arcs module tests passed"</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `node db/modules/character-arcs.js` runs self-test and passes
- [ ] Module exports all 7 functions (createArc, getArcsByProject, getArcByCharacter, getArcById, updateArc, deleteArc, advancePhase)
- [ ] JSDoc comments document each function
- [ ] Phase validation enforces 13 valid Save the Cat phases
- [ ] advancePhase correctly sequences through all 13 phases
- [ ] Nullable fields (archetype, lie_belief, etc.) handle null gracefully
</verification>

<success_criteria>

- All tasks completed
- character-arcs.js module exists with 7 exported functions
- CRUD operations follow event-moments.js and causality-chains.js patterns
- advancePhase helper simplifies sequential phase progression
- Self-test passes with phase advancement working correctly
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/03-logic-layer-modules-causality-arcs/03-02-SUMMARY.md`
</output>
