---
phase: 03-logic-layer-modules-causality-arcs
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [db/modules/causality-chains.js]
autonomous: true

must_haves:
  truths:
    - "User can create causality chain linking two events"
    - "User can retrieve causality chains by cause event"
    - "User can retrieve causality chains by effect event"
    - "User can traverse full causal chain with depth limiting"
    - "Causality strength (1-10) and type (direct_cause, enabling_condition, motivation, psychological_trigger) are tracked"
  artifacts:
    - path: "db/modules/causality-chains.js"
      provides: "CRUD operations for causality chains"
      min_lines: 150
      exports: ["createChain", "getChainsByCause", "getChainsByEffect", "getChainById", "updateChain", "deleteChain", "traverseChain"]
  key_links:
    - from: "db/modules/causality-chains.js"
      to: "causality_chains table"
      via: "SQL prepared statements"
      pattern: "db\\.prepare.*causality_chains"
---

<objective>
Implement causality-chains.js module with full CRUD operations and causal chain traversal.

Purpose: Enable tracking of cause-effect relationships between events with strength quantification and depth-limited graph traversal for "why this happened" analysis.
Output: Working database module exposing causality tracking functions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase summaries
@.planning/phases/02-logic-layer-schema/02-01-SUMMARY.md

# Existing patterns to follow
@db/modules/event-moments.js
@db/migrations/006_logic_layer.sql

# Codebase architecture
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create causality-chains.js with CRUD operations</name>
  <files>db/modules/causality-chains.js</files>
  <action>
Create db/modules/causality-chains.js following the module pattern from event-moments.js:

1. Module exports function that takes db parameter and returns object with exported functions
2. Import uuid: `const { v4: uuidv4 } = require('uuid');`
3. Implement CRUD functions:
   - `createChain(projectId, causeEventId, effectEventId, type, strength, explanation)` - Creates new chain with UUID, validates type enum, validates strength 1-10, returns chain object
   - `getChainsByCause(causeEventId)` - Returns all chains where cause_event_id matches
   - `getChainsByEffect(effectEventId)` - Returns all chains where effect_event_id matches
   - `getChainById(chainUuid)` - Returns single chain or null
   - `updateChain(chainUuid, updates)` - Updates allowed fields (type, strength, explanation), returns updated chain or null
   - `deleteChain(chainUuid)` - Deletes chain, returns true/false
4. Use prepared statements for all queries: `db.prepare(sql).run/get/all(params)`
5. Follow snake_case for database columns, camelCase for parameters
6. Include JSDoc comments for each function explaining parameters and return values
7. Validate type enum: ['direct_cause', 'enabling_condition', 'motivation', 'psychological_trigger']
8. Validate strength: integer 1-10 inclusive

DO NOT implement traverseChain yet (Task 2). Keep CRUD functions simple and focused.

Schema reference (from 006_logic_layer.sql):
- chain_uuid TEXT PRIMARY KEY
- project_id TEXT NOT NULL
- cause_event_id TEXT NOT NULL
- effect_event_id TEXT NOT NULL
- type TEXT NOT NULL CHECK(type IN ('direct_cause', 'enabling_condition', 'motivation', 'psychological_trigger'))
- strength INTEGER NOT NULL CHECK(strength >= 1 AND strength <= 10)
- explanation TEXT NOT NULL
- created_at INTEGER NOT NULL
  </action>
  <verify>node -e "const m = require('./db/modules/causality-chains.js'); console.log(Object.keys(m({ prepare: () => ({}) })))"</verify>
  <done>Module exports createChain, getChainsByCause, getChainsByEffect, getChainById, updateChain, deleteChain functions</done>
</task>

<task type="auto">
  <name>Task 2: Add traverseChain function with depth limiting</name>
  <files>db/modules/causality-chains.js</files>
  <action>
Add traverseChain function to causality-chains.js module for graph traversal:

**Function signature:**
```javascript
const traverseChain = (eventId, direction = 'forward', depth = 3, maxDepth = 10) => {
  // Returns graph of causal relationships
}
```

**Implementation:**
1. Validate depth: must be 1-10, default 3, never exceed maxDepth
2. Direction: 'forward' (this event → effects) or 'backward' (causes → this event)
3. Use breadth-first search to avoid infinite loops
4. Track visited nodes to prevent cycles
5. Build graph structure:
```javascript
{
  nodes: [
    { event_id: 'evt-001', level: 0 },
    { event_id: 'evt-002', level: 1 },
    ...
  ],
  edges: [
    {
      from: 'evt-001',
      to: 'evt-002',
      type: 'direct_cause',
      strength: 8,
      explanation: '...'
    },
    ...
  ]
}
```
6. Level 0 = starting event, Level 1 = direct connections, Level 2 = connections of connections, etc.
7. Stop when level >= depth or no more nodes to explore
8. For 'forward' direction: query getChainsByCause for each node
9. For 'backward' direction: query getChainsByEffect for each node
10. Return object with nodes array and edges array

**Why depth limiting:**
- Prevents performance issues with deep graphs
- Limits to 50 nodes max recommended (mentioned in ROADMAP.md GUI requirements)
- Default depth 3 balances insight vs performance
  </action>
  <verify>node -e "const db = require('better-sqlite3')(':memory:'); const m = require('./db/modules/causality-chains.js')(db); console.log(typeof m.traverseChain)"</verify>
  <done>traverseChain function exists, validates depth 1-10, returns graph with nodes/edges arrays</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for causality-chains module</name>
  <files>db/modules/causality-chains.js</files>
  <action>
Add inline validation and basic smoke test at bottom of causality-chains.js:

**If module is run directly (not imported), execute self-test:**
```javascript
if (require.main === module) {
  const Database = require('better-sqlite3');
  const testDb = new Database(':memory:');

  // Create table
  testDb.exec(`
    CREATE TABLE causality_chains (
      chain_uuid TEXT PRIMARY KEY,
      project_id TEXT NOT NULL,
      cause_event_id TEXT NOT NULL,
      effect_event_id TEXT NOT NULL,
      type TEXT NOT NULL CHECK(type IN ('direct_cause', 'enabling_condition', 'motivation', 'psychological_trigger')),
      strength INTEGER NOT NULL CHECK(strength >= 1 AND strength <= 10),
      explanation TEXT NOT NULL,
      created_at INTEGER NOT NULL
    )
  `);

  const module = require('./causality-chains')(testDb);

  // Test 1: Create chain
  const chain = module.createChain('proj-001', 'evt-001', 'evt-002', 'direct_cause', 8, 'Event 001 directly caused event 002');
  console.assert(chain.type === 'direct_cause', 'Chain type should be direct_cause');
  console.assert(chain.strength === 8, 'Chain strength should be 8');

  // Test 2: Retrieve by cause
  const byCause = module.getChainsByCause('evt-001');
  console.assert(byCause.length === 1, 'Should find 1 chain by cause');

  // Test 3: Retrieve by effect
  const byEffect = module.getChainsByEffect('evt-002');
  console.assert(byEffect.length === 1, 'Should find 1 chain by effect');

  // Test 4: Traverse (basic - no actual chain to traverse)
  const graph = module.traverseChain('evt-001', 'forward', 2);
  console.assert(graph.nodes.length >= 0, 'Graph should have nodes array');
  console.assert(graph.edges.length >= 0, 'Graph should have edges array');

  console.log('✓ All causality-chains module tests passed');
}
```

Run self-test with: `node db/modules/causality-chains.js`
  </action>
  <verify>node db/modules/causality-chains.js</verify>
  <done>Self-test passes, prints "✓ All causality-chains module tests passed"</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `node db/modules/causality-chains.js` runs self-test and passes
- [ ] Module exports all 7 functions (createChain, getChainsByCause, getChainsByEffect, getChainById, updateChain, deleteChain, traverseChain)
- [ ] JSDoc comments document each function
- [ ] Type validation enforces 4 valid causality types
- [ ] Strength validation enforces 1-10 range
- [ ] traverseChain validates depth 1-10 with default 3
</verification>

<success_criteria>

- All tasks completed
- causality-chains.js module exists with 7 exported functions
- CRUD operations follow event-moments.js pattern
- traverseChain implements breadth-first search with depth limiting
- Self-test passes
- No errors or warnings introduced
  </success_criteria>

<output>
After completion, create `.planning/phases/03-logic-layer-modules-causality-arcs/03-01-SUMMARY.md`
</output>
