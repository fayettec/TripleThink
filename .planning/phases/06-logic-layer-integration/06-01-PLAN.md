---
phase: 06-logic-layer-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [db/api-functions.js]
autonomous: true

must_haves:
  truths:
    - "Logic layer functions accessible through unified facade"
    - "Facade exports match module structures"
    - "Facade can be required from API routes"
  artifacts:
    - path: "db/api-functions.js"
      provides: "Unified facade for all 7 logic layer modules"
      exports: ["causalityChains", "characterArcs", "storyConflicts", "thematicElements", "motifInstances", "setupPayoffs", "worldRules"]
      min_lines: 50
  key_links:
    - from: "db/api-functions.js"
      to: "db/modules/*.js"
      via: "require() imports"
      pattern: "require\\('\\./modules/"
---

<objective>
Create unified database facade (db/api-functions.js) exposing all 7 logic layer modules through single import point

Purpose: Provide clean API for routes and orchestrator to access logic layer without importing 7 separate modules
Output: db/api-functions.js facade with consistent interface to causality-chains, character-arcs, story-conflicts, thematic-elements, motif-instances, setup-payoffs, world-rules
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Relevant codebase context
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

# Phase 5 context - what modules exist
@.planning/phases/05-logic-modules-motifs-setups-rules/05-01-SUMMARY.md
@.planning/phases/05-logic-modules-motifs-setups-rules/05-02-SUMMARY.md

# Existing orchestrator pattern
@api/services/orchestrator.js

# All 7 logic layer modules to integrate
@db/modules/causality-chains.js
@db/modules/character-arcs.js
@db/modules/story-conflicts.js
@db/modules/thematic-elements.js
@db/modules/motif-instances.js
@db/modules/setup-payoffs.js
@db/modules/world-rules.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create db/api-functions.js facade with all 7 module imports</name>
  <files>db/api-functions.js</files>
  <action>
Create db/api-functions.js that imports and exports all 7 logic layer modules with consistent naming:

**Pattern to follow:**
```javascript
// Module imports
const causalityChains = require('./modules/causality-chains');
const characterArcs = require('./modules/character-arcs');
const storyConflicts = require('./modules/story-conflicts');
const thematicElements = require('./modules/thematic-elements');
const motifInstances = require('./modules/motif-instances');
const setupPayoffs = require('./modules/setup-payoffs');
const worldRules = require('./modules/world-rules');

// Factory function that takes db and returns all module functions initialized with that db
function createAPI(db) {
  return {
    causalityChains: causalityChains(db),
    characterArcs: characterArcs(db),
    storyConflicts: storyConflicts(db),
    thematicElements: thematicElements(db),
    motifInstances: motifInstances(db),
    setupPayoffs: setupPayoffs(db),
    worldRules: worldRules(db)
  };
}

module.exports = createAPI;
```

Each module uses the module factory pattern (function takes db, returns object with methods). This facade wraps them consistently.

**JSDoc comment at top:**
- Purpose: Unified database facade for TripleThink v4.1 Logic Layer
- Lists all 7 modules and their purposes (causality tracking, character arcs, conflicts, themes, motifs, setup/payoffs, world rules)
  </action>
  <verify>
node -e "const api = require('./db/api-functions'); const Database = require('better-sqlite3'); const db = new Database(':memory:'); const facade = api(db); console.log(Object.keys(facade));" should output array with 7 module names
  </verify>
  <done>db/api-functions.js exists, requires all 7 modules, exports factory function returning initialized modules</done>
</task>

<task type="auto">
  <name>Task 2: Verify facade structure and test basic require</name>
  <files>db/api-functions.js</files>
  <action>
Create simple test script at db/test-api-facade.js:
- Import api-functions
- Create in-memory database
- Call api(db) to get facade
- Verify all 7 properties exist: causalityChains, characterArcs, storyConflicts, thematicElements, motifInstances, setupPayoffs, worldRules
- For each property, verify it has expected functions (e.g., causalityChains has createCausalityChain, getCausalityChainsByProject, etc.)
- Run the test script: `node db/test-api-facade.js`
- Script should exit 0 if all verifications pass

Use console.log for progress, throw Error if any verification fails.
  </action>
  <verify>node db/test-api-facade.js exits with code 0 and outputs "âœ“ All facade modules loaded"</verify>
  <done>Facade structure verified, all 7 modules accessible through api(db) factory function</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] db/api-functions.js exists and has JSDoc header
- [ ] All 7 modules imported with consistent camelCase naming
- [ ] Factory function pattern matches existing orchestrator pattern
- [ ] Test script verifies all modules accessible
- [ ] No TypeScript/linting errors
</verification>

<success_criteria>
- All tasks completed
- db/api-functions.js provides unified access to logic layer
- Test script confirms facade structure
- Code follows project conventions (camelCase exports, JSDoc comments, module factory pattern)
</success_criteria>

<output>
After completion, create `.planning/phases/06-logic-layer-integration/06-01-SUMMARY.md`
</output>
