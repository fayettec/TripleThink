---
phase: 01-foundation-enhancement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - db/migrations/005_event_moments.sql
  - db/modules/event-moments.js
autonomous: true

must_haves:
  truths:
    - "EVENT_MOMENTS table exists in database with proper schema"
    - "Database module provides create, read, update, delete operations for moments"
    - "Moments can be queried by event_uuid"
    - "Moments return in sequence_index order"
  artifacts:
    - path: "db/migrations/005_event_moments.sql"
      provides: "EVENT_MOMENTS table schema"
      min_lines: 15
      contains: "CREATE TABLE IF NOT EXISTS event_moments"
    - path: "db/modules/event-moments.js"
      provides: "CRUD operations for moments"
      min_lines: 80
      exports: ["createMoment", "getMomentsByEvent", "updateMoment", "deleteMoment"]
  key_links:
    - from: "event-moments.js"
      to: "db/triplethink.db"
      via: "better-sqlite3 prepared statements"
      pattern: "db\\.prepare\\("
---

<objective>
Create EVENT_MOMENTS database table and module for granular beat tracking within events.

Purpose: Enables authors to track individual story beats (moments) within larger events, providing fine-grained causality and pacing control. Foundation for Logic Layer causality chains in Phase 2.

Output: Migration script and database module with full CRUD operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md

# Codebase context
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/STACK.md

# Existing migrations for pattern reference
@db/migrations/001_foundation.sql
@db/migrations/002_hybrid_state.sql
@db/migrations/004_narrative.sql

# Existing modules for pattern reference
@db/modules/state-deltas.js
@db/modules/state-snapshots.js
@db/modules/epistemic.js

# Migration runner
@db/run-migration.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EVENT_MOMENTS migration script</name>
  <files>db/migrations/005_event_moments.sql</files>
  <action>
Create `005_event_moments.sql` following existing migration patterns.

**Schema:**
```sql
CREATE TABLE IF NOT EXISTS event_moments (
  moment_uuid TEXT PRIMARY KEY,
  event_uuid TEXT NOT NULL,
  sequence_index INTEGER NOT NULL,
  beat_description TEXT NOT NULL,
  timestamp_offset INTEGER,  -- Optional: offset from event timestamp in seconds
  created_at INTEGER NOT NULL,
  FOREIGN KEY (event_uuid) REFERENCES ... -- Note: No EVENTS table exists yet, defer FK
);
```

**Indexes:**
- `idx_moments_event` on `event_uuid` for fast event lookup
- `idx_moments_sequence` on `(event_uuid, sequence_index)` for ordered retrieval

**Critical:** Do NOT add FOREIGN KEY constraint on event_uuid yet - EVENTS table doesn't exist. Add comment noting this will be added in Phase 2 when EVENTS table is created.

Follow patterns from existing migrations:
- Header comment explaining purpose
- Event sourcing note: "tables are append-only"
- IF NOT EXISTS for idempotency
- snake_case column names
- INTEGER for timestamps (Unix epoch)
</action>
  <verify>
```bash
# Run migration
node db/run-migration.js 005_event_moments.sql

# Verify table exists
node -e "const db = require('better-sqlite3')('db/triplethink.db'); console.log(db.prepare('SELECT sql FROM sqlite_master WHERE name = ?').get('event_moments'));"
```
  </verify>
  <done>
- Migration script exists at `db/migrations/005_event_moments.sql`
- Script follows existing patterns (header, IF NOT EXISTS, indexes)
- Migration runs without errors
- Table schema matches requirements (moment_uuid, event_uuid, sequence_index, beat_description, timestamp_offset)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create event-moments.js database module</name>
  <files>db/modules/event-moments.js</files>
  <action>
Create `event-moments.js` following existing module patterns (`epistemic.js`, `state-deltas.js`).

**Module structure:**
```javascript
// Event Moments Module
// CRUD operations for EVENT_MOMENTS table
// Provides granular beat tracking within events

const { v4: uuidv4 } = require('uuid');

module.exports = (db) => {
  // CREATE
  const createMoment = (eventUuid, sequenceIndex, beatDescription, timestampOffset = null) => {
    // Generate moment_uuid
    // Prepare INSERT statement
    // Execute with parameters
    // Return created moment object
  };

  // READ
  const getMomentsByEvent = (eventUuid) => {
    // Query moments for event_uuid
    // ORDER BY sequence_index ASC
    // Return array of moment objects
  };

  const getMomentById = (momentUuid) => {
    // Query single moment by moment_uuid
    // Return moment object or null
  };

  // UPDATE
  const updateMoment = (momentUuid, updates) => {
    // Build UPDATE statement dynamically based on updates object
    // Allow updating: sequence_index, beat_description, timestamp_offset
    // Do NOT allow updating moment_uuid or event_uuid (immutability)
    // Return updated moment
  };

  // DELETE
  const deleteMoment = (momentUuid) => {
    // DELETE FROM event_moments WHERE moment_uuid = ?
    // Return boolean success
  };

  return {
    createMoment,
    getMomentsByEvent,
    getMomentById,
    updateMoment,
    deleteMoment
  };
};
```

**Key patterns to follow:**
- Export function that accepts `db` parameter (better-sqlite3 instance)
- Use `db.prepare()` for SQL statements (prepared statements pattern)
- Use `uuidv4()` for generating moment_uuid
- Use `Date.now()` for created_at timestamp
- Return objects, not raw database rows where appropriate
- Add JSDoc comments for each exported function
- Handle errors appropriately (let them bubble, don't swallow)

**Critical:** Use `.all()` for getMomentsByEvent (returns array), `.get()` for getMomentById (returns single row), `.run()` for create/update/delete (returns info object).
  </action>
  <verify>
```bash
# Test module loads without syntax errors
node -e "const db = require('better-sqlite3')('db/triplethink.db'); const moments = require('./db/modules/event-moments')(db); console.log(Object.keys(moments));"

# Verify exports
node -e "const db = require('better-sqlite3')('db/triplethink.db'); const m = require('./db/modules/event-moments')(db); console.log(['createMoment', 'getMomentsByEvent', 'getMomentById', 'updateMoment', 'deleteMoment'].every(fn => typeof m[fn] === 'function'));"
```
  </verify>
  <done>
- Module exists at `db/modules/event-moments.js`
- Exports 5 functions: createMoment, getMomentsByEvent, getMomentById, updateMoment, deleteMoment
- Module loads without errors
- Functions use prepared statements pattern
- UUIDs generated for moment_uuid
- getMomentsByEvent returns moments ordered by sequence_index
  </done>
</task>

<task type="auto">
  <name>Task 3: Manual verification with test data</name>
  <files>None (verification only)</files>
  <action>
Create and verify test moments manually to confirm functionality.

**Test script:**
```javascript
const Database = require('better-sqlite3');
const db = new Database('db/triplethink.db');
const moments = require('./db/modules/event-moments')(db);

// Create test moments
const testEventUuid = 'test-event-001';
const m1 = moments.createMoment(testEventUuid, 1, 'Character enters room', 0);
const m2 = moments.createMoment(testEventUuid, 2, 'Character sees mysterious object', 30);
const m3 = moments.createMoment(testEventUuid, 3, 'Character picks up object', 45);

console.log('Created moments:', m1, m2, m3);

// Query moments
const retrieved = moments.getMomentsByEvent(testEventUuid);
console.log('Retrieved moments (should be 3, ordered):', retrieved);

// Update moment
const updated = moments.updateMoment(m2.moment_uuid, { beat_description: 'Character stares at mysterious artifact' });
console.log('Updated moment:', updated);

// Verify order preserved
const ordered = moments.getMomentsByEvent(testEventUuid);
console.log('Moments still ordered?', ordered.map(m => m.sequence_index)); // Should be [1, 2, 3]

// Delete moment
const deleted = moments.deleteMoment(m3.moment_uuid);
console.log('Deleted moment?', deleted); // Should be true

// Verify deletion
const afterDelete = moments.getMomentsByEvent(testEventUuid);
console.log('Moments after delete (should be 2):', afterDelete.length);

db.close();
```

Save as `verify-moments.js` in project root, run with `node verify-moments.js`, then delete file after verification.
  </action>
  <verify>
```bash
# Run verification script
node verify-moments.js

# Check output matches expectations:
# - 3 moments created with correct sequence_index
# - Retrieved moments ordered by sequence_index
# - Update succeeded
# - Delete succeeded
# - Final count is 2

# Clean up
rm verify-moments.js
```
  </verify>
  <done>
- Test script runs without errors
- Create operation generates valid UUIDs and timestamps
- getMomentsByEvent returns moments in sequence_index order
- Update operation modifies beat_description correctly
- Delete operation removes moment from database
- Verification confirms all CRUD operations functional
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Migration script exists and runs successfully
- [ ] EVENT_MOMENTS table exists in database with correct schema
- [ ] event-moments.js module loads and exports 5 functions
- [ ] Manual verification confirms CRUD operations work correctly
- [ ] Moments return ordered by sequence_index
- [ ] No errors or warnings in verification output
</verification>

<success_criteria>
- All tasks completed
- EVENT_MOMENTS table operational in database
- Database module provides full CRUD functionality
- Manual verification confirms sequencing works correctly
- Ready for API endpoint integration (Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-enhancement/01-01-SUMMARY.md`
</output>
