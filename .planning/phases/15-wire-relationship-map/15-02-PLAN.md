---
phase: 15-wire-relationship-map
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - db/modules/relationships.js
  - api/routes/epistemic.js
  - gui/js/api-client.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Network graph displays with color-coded relationship edges"
    - "Component successfully fetches all relationships for current fiction"
  artifacts:
    - path: "db/modules/relationships.js"
      provides: "getAllRelationships() function to query all relationships in a fiction"
      exports: ["getAllRelationships"]
    - path: "api/routes/epistemic.js"
      provides: "GET /api/epistemic/relationships endpoint with fiction_id query param"
      contains: "router.get('/relationships',"
    - path: "gui/js/api-client.js"
      provides: "Correct API path to /api/epistemic/relationships"
      contains: "/api/epistemic/relationships"
  key_links:
    - from: "api-client.js getRelationships()"
      to: "/api/epistemic/relationships"
      via: "HTTP GET request"
      pattern: "/api/epistemic/relationships\\?fiction_id="
    - from: "API route GET /epistemic/relationships"
      to: "relationships.getAllRelationships()"
      via: "database module call"
      pattern: "relationships\\.getAllRelationships"
---

<objective>
Fix API endpoint mismatch preventing RelationshipMap from displaying data.

Purpose: Close the gap identified in verification - component calls wrong endpoint and no query endpoint exists for all relationships in a fiction
Output: Working end-to-end flow from RelationshipMap component through API to database
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-wire-relationship-map/15-VERIFICATION.md
@.planning/phases/12-gui-advanced-features/12-03-SUMMARY.md

## Gap Context

Verification identified that RelationshipMap component is fully wired into the GUI but cannot fetch data because:

1. **API Path Mismatch**: `api-client.js` calls `/api/relationships` but endpoints are at `/api/epistemic/relationships`
2. **Missing Query Endpoint**: No endpoint exists to query all relationships for a fiction (only get by ID or by entity)
3. **Missing Database Function**: `relationships.js` lacks `getAllRelationships()` function

## Existing Implementation

**Database module** (db/modules/relationships.js):
- Exports: recordRelationship, getRelationship, getRelationshipAt, getRelationshipsFor, getRelationshipHistory, findBySentiment, findConflicts, getRelationshipDelta
- Missing: getAllRelationships(db, fictionId, timestamp)

**API routes** (api/routes/epistemic.js):
- Existing endpoints:
  - POST /relationships (create)
  - GET /relationships/:id (get by ID)
  - GET /relationships/between/:entityAId/:entityBId (get specific pair)
  - GET /entities/:entityId/relationships (get for one entity)
  - GET /relationships/conflicts (find conflicts)
  - GET /relationships/delta/:entityAId/:entityBId (get delta)
- Missing: GET /relationships?fiction_id={id} (query all for fiction)

**API client** (gui/js/api-client.js):
- Line 741: `return this.request('/api/relationships?fiction_id=${fictionId}');`
- Should be: `return this.request('/api/epistemic/relationships?fiction_id=${fictionId}');`

## Reference Implementation

**getRelationshipsFor()** (relationships.js:133-157) pattern to follow:
- Takes db, entityId, fictionId, timestamp
- Queries RELATIONSHIPS table with fiction_id filter
- Joins with NARRATIVE_DELTAS for temporal queries
- Returns array of relationship objects

**GET /entities/:entityId/relationships** (epistemic.js:218-243) pattern to follow:
- Calls relationships.getRelationshipsFor(db, entityId, fictionId, timestamp)
- Returns 200 with array
- Handles errors with 500
</context>

<tasks>

<task type="auto">
  <name>Add getAllRelationships() function to database module</name>
  <files>db/modules/relationships.js</files>
  <action>
Add getAllRelationships(db, fictionId, timestamp = null) function before module.exports.

Function behavior:
- Query RELATIONSHIPS table with WHERE fiction_id = ?
- If timestamp provided, filter to relationships where recorded_at <= timestamp
- Return array of relationship objects with all fields (relationship_id, entity_a_id, entity_b_id, trust, fear, respect, power_balance, recorded_at, fiction_id)
- No need for NARRATIVE_DELTAS join (relationships already have fiction_id directly in table)

Pattern to follow from getRelationshipsFor() (lines 133-157):
- Use db.prepare() with parameterized query
- Use .all() to get array of results
- Handle timestamp filtering with recorded_at <= ?

Export the new function in module.exports after getRelationshipDelta (add to line 314).
  </action>
  <verify>grep -A 10 "function getAllRelationships" db/modules/relationships.js confirms function exists and is exported</verify>
  <done>getAllRelationships() function exists, exported, and follows temporal query pattern from existing code</done>
</task>

<task type="auto">
  <name>Add GET /relationships query endpoint to API</name>
  <files>api/routes/epistemic.js</files>
  <action>
Add GET /relationships endpoint BEFORE the existing POST /relationships endpoint (before line 166).

Endpoint behavior:
- Extract fiction_id from query params (required)
- Extract timestamp from query params (optional)
- Call relationships.getAllRelationships(db, fictionId, timestamp)
- Return 200 with array of relationships
- Return 400 if fiction_id missing
- Return 500 on database errors

Pattern to follow from GET /entities/:entityId/relationships (lines 218-243):
```javascript
router.get('/relationships', (req, res) => {
  const { fiction_id, timestamp } = req.query;

  if (!fiction_id) {
    return res.status(400).json({ error: 'fiction_id query parameter required' });
  }

  const ts = timestamp ? parseInt(timestamp) : null;

  try {
    const rels = relationships.getAllRelationships(db, fiction_id, ts);
    res.json(rels);
  } catch (error) {
    console.error('Error fetching relationships:', error);
    res.status(500).json({ error: error.message });
  }
});
```

Add comment above route: "// Query all relationships in a fiction (for visualization)"
  </action>
  <verify>grep -B 2 "Query all relationships in a fiction" api/routes/epistemic.js confirms endpoint added</verify>
  <done>GET /relationships endpoint exists, handles fiction_id query param, calls getAllRelationships()</done>
</task>

<task type="auto">
  <name>Fix API client path to use correct endpoint</name>
  <files>gui/js/api-client.js</files>
  <action>
Update line 741 in getRelationships() method.

Change:
  return this.request(`/api/relationships?fiction_id=${fictionId}`);

To:
  return this.request(`/api/epistemic/relationships?fiction_id=${fictionId}`);

This fixes the path mismatch - API client now calls the correct endpoint at /api/epistemic/relationships instead of the non-existent /api/relationships.
  </action>
  <verify>grep "api/epistemic/relationships" gui/js/api-client.js | grep "fiction_id" confirms fix applied</verify>
  <done>API client calls /api/epistemic/relationships?fiction_id={id} matching actual endpoint path</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] getAllRelationships() function exists in db/modules/relationships.js and is exported
- [ ] GET /relationships endpoint exists in api/routes/epistemic.js before POST endpoint
- [ ] gui/js/api-client.js calls /api/epistemic/relationships (not /api/relationships)
- [ ] Test the full flow: start server, open GUI, click Characters → Relationships tab, verify no 404 errors in console
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- RelationshipMap component can successfully fetch relationships data
- No API path mismatch errors
- End-to-end flow works: GUI → API client → API endpoint → database module
  </success_criteria>

<output>
After completion, create `.planning/phases/15-wire-relationship-map/15-02-SUMMARY.md`
</output>
