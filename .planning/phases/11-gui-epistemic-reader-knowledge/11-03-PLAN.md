---
phase: 11-gui-epistemic-reader-knowledge
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - gui/js/screens/timeline.js
  - gui/js/screens/characters.js
  - gui/styles/screens.css
autonomous: true

must_haves:
  truths:
    - "User can toggle epistemic states on/off in timeline view"
    - "User can see causality arrows between events on timeline"
    - "User can view character arcs from characters screen"
    - "User can open epistemic modal from characters screen to see what character knows"
  artifacts:
    - path: "gui/js/screens/timeline.js"
      provides: "Timeline with epistemic toggle and causality arrows"
      min_lines: 120
    - path: "gui/js/screens/characters.js"
      provides: "Character list with arcs and knowledge inspection"
      min_lines: 100
  key_links:
    - from: "timeline.js"
      to: "/api/epistemic/knowledge"
      via: "fetches knowledge states per event"
      pattern: "api\\.request.*epistemic"
    - from: "timeline.js"
      to: "/api/logic/causality"
      via: "fetches causal chains for arrows"
      pattern: "api\\.request.*causality"
    - from: "characters.js"
      to: "arc-card.js"
      via: "renders character arcs"
      pattern: "ArcCard\\.render"
    - from: "characters.js"
      to: "epistemic.js"
      via: "opens knowledge modal"
      pattern: "EpistemicScreen"
---

<objective>
Enhance timeline and characters screens with epistemic and logic layer features.

Purpose: Integrate knowledge tracking and story structure visualization into existing screens for comprehensive narrative overview.
Output: Timeline with epistemic toggle and causality arrows, characters screen with arc integration and knowledge modal.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/08-gui-core-infrastructure/08-01-SUMMARY.md
@.planning/phases/09-gui-logic-visualization/09-01-SUMMARY.md
@.planning/phases/09-gui-logic-visualization/09-02-SUMMARY.md

@gui/js/screens/timeline.js
@gui/js/screens/characters.js
@gui/js/components/arc-card.js
@gui/js/components/causality-graph.js
@api/routes/epistemic.js
@api/routes/logic-layer.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance timeline.js with epistemic toggle and causality arrows</name>
  <files>gui/js/screens/timeline.js, gui/styles/screens.css</files>
  <action>
Enhance timeline screen with epistemic state display and causality arrows.

Current state: Timeline displays events in chronological order (check existing implementation).

New features:

1. **Epistemic toggle** (in header):
   - Checkbox: "Show Knowledge States" (default: unchecked)
   - When checked:
     - Each event shows knowledge badges below event card
     - For each present character, show badge: "[CharName] knows: X facts"
     - Click badge to expand knowledge list for that character at that event
   - When unchecked: hide all knowledge badges (cleaner view)

2. **Causality arrows** (between events):
   - Checkbox: "Show Causality" (default: unchecked)
   - When checked:
     - Fetch causality chains from /api/logic/causality for all visible events
     - Draw SVG arrows between events with causal relationships
     - Arrow colors match causality-graph.js pattern:
       - Red: direct-cause
       - Blue: enabling-condition
       - Purple: motivation
       - Orange: psychological-trigger
     - Arrow hover shows tooltip: "[Type]: [explanation]"
   - When unchecked: hide arrows

Implementation details:

Epistemic display:
- API call: GET /api/epistemic/knowledge/${characterId}?at=${eventTimestamp}
- For each event, get present characters (event.presentEntityIds filtered to type='character')
- For each character, fetch knowledge at event timestamp
- Render badges: `<span class="knowledge-badge">${charName}: ${facts.length} facts</span>`
- Click badge to toggle expanded fact list

Causality arrows:
- Use causality-graph.js D3 patterns for SVG arrow rendering
- Position arrows based on event DOM element positions (getBoundingClientRect)
- Arrows connect event card centers with curved paths
- Use d3.line() with curveBundle for smooth curves
- Store arrow state in component state to persist across re-renders

CSS (in screens.css):
```css
.timeline-event .knowledge-badge {
  display: inline-block;
  background: #e3f2fd;
  color: #1976d2;
  padding: 4px 8px;
  border-radius: 12px;
  font-size: 12px;
  margin: 4px;
  cursor: pointer;
}

.timeline-event .knowledge-facts {
  display: none;
  margin-top: 8px;
  padding: 8px;
  background: #f5f5f5;
  border-left: 3px solid #1976d2;
}

.timeline-event .knowledge-facts.expanded {
  display: block;
}

.causality-arrow {
  fill: none;
  stroke-width: 2;
  marker-end: url(#arrowhead);
}

.causality-arrow.direct-cause { stroke: #f44336; }
.causality-arrow.enabling-condition { stroke: #2196f3; }
.causality-arrow.motivation { stroke: #9c27b0; }
.causality-arrow.psychological-trigger { stroke: #ff9800; }
```

Follow timeline-viz.js patterns if timeline visualization already exists.
If timeline.js is currently minimal, use story-logic.js screen structure as template.
  </action>
  <verify>Timeline has 2 checkboxes (epistemic, causality), knowledge badges render, arrows connect events</verify>
  <done>Users can toggle epistemic/causality overlays on timeline, see knowledge per character, see causal relationships</done>
</task>

<task type="auto">
  <name>Task 2: Enhance characters.js with arc integration and knowledge modal</name>
  <files>gui/js/screens/characters.js</files>
  <action>
Enhance characters screen to display character arcs and provide knowledge inspection.

Current state: Characters screen likely shows character list (check existing implementation).

New features:

1. **Character arc cards** (main content):
   - For each character, render ArcCard.render(characterId) from Phase 9
   - Arc card shows:
     - Character name and archetype
     - Current arc phase (Setup, Catalyst, Debate, Midpoint, etc.)
     - Progress bar (% through Save the Cat beats)
     - Lie/Truth, Want/Need
   - Layout: Grid of cards (similar to story-logic.js arc tab)

2. **"What They Know" button** (on each character card):
   - Button below arc card: "üß† What They Know"
   - Click opens modal showing character's epistemic state
   - Modal content:
     - Header: "[Character Name]'s Knowledge"
     - Timestamp selector: "At [timestamp]" (default: state.currentTimestamp or "now")
     - Knowledge list:
       - Facts character knows (from /api/epistemic/knowledge/${characterId})
       - False beliefs highlighted in orange (from Plan 11-02)
     - "View in Epistemic Graph" button to navigate to epistemic screen with character pre-selected
   - Modal uses existing modal pattern (see narrative.js or story-logic.js)

3. **Layer switcher integration**:
   - Render LayerSwitcher.init() in header area
   - When viewMode changes to 'character-view', highlight selected character's card
   - When viewMode is 'reader-view', show "Reader knows" badge on each character card

Implementation:

Arc integration:
- Import ArcCard from Phase 9: `const ArcCard = ...` (check how components are imported)
- Fetch character arcs: GET /api/logic/arcs?characterId=${charId}
- For each character, get arc and render ArcCard.render(arc)
- Grid layout: `display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));`

Knowledge modal:
- Modal structure:
```javascript
function showKnowledgeModal(characterId) {
  const modal = document.createElement('div');
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2>${character.name}'s Knowledge</h2>
        <button onclick="closeModal()">‚úï</button>
      </div>
      <div class="modal-body">
        <!-- timestamp selector -->
        <!-- knowledge list -->
      </div>
      <div class="modal-footer">
        <button onclick="navigateToEpistemic()">View in Epistemic Graph</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);
}
```

- Fetch knowledge: GET /api/epistemic/knowledge/${characterId}?at=${timestamp}
- Render facts with false beliefs in orange (check response for falseBelief flag or compare with world truth)

State subscriptions:
- Subscribe to state.selectedCharacter to highlight card
- Subscribe to state.viewMode to show/hide reader knowledge badges
- Subscribe to state.currentTimestamp to update knowledge display

Follow story-logic.js pattern for screen layout with cards.
Follow narrative.js pattern for modal structure.
  </action>
  <verify>Characters screen shows arc cards, "What They Know" button opens modal with knowledge list</verify>
  <done>Users can view character arcs on characters screen, inspect character knowledge via modal, navigate to epistemic graph</done>
</task>

<task type="auto">
  <name>Task 3: Add empty states and power drawer integration</name>
  <files>gui/js/screens/timeline.js, gui/js/screens/characters.js</files>
  <action>
Add comprehensive empty states and power drawer integration to both screens.

Timeline screen empty states:
1. No project selected:
   - Icon: ‚è±Ô∏è
   - Message: "No project selected"
   - Hint: "Select a project to view timeline"

2. Project selected but no events:
   - Icon: üìÖ
   - Message: "No events in timeline yet"
   - Hint: "Create events to build your story timeline"

3. Epistemic toggle on but no knowledge data:
   - Show events normally
   - Show info banner: "‚ÑπÔ∏è No knowledge data for these events. Track character knowledge via scene editor."

4. Causality toggle on but no causality chains:
   - Show events normally
   - Show info banner: "‚ÑπÔ∏è No causal relationships defined. Create causality chains in Story Logic screen."

Characters screen empty states:
1. No project selected:
   - Icon: üë•
   - Message: "No project selected"
   - Hint: "Select a project to view characters"

2. Project selected but no characters:
   - Icon: üé≠
   - Message: "No characters yet"
   - Hint: "Create characters to track their arcs and knowledge"

3. Characters exist but no arcs defined:
   - Show character cards without arc section
   - Info badge: "Arc not defined yet"
   - "Define Arc" button to navigate to story-logic screen

4. Character has arc but no knowledge data:
   - "What They Know" button shows: "No knowledge tracked yet"
   - Hint: "Track knowledge via scene editor"

Power drawer integration:
- Both screens: add power drawer toggle button in header
- Timeline: power drawer shows selected event details when event clicked
- Characters: power drawer shows selected character details when card clicked

Follow patterns:
- Empty states: story-logic.js, narrative.js
- Power drawer: all Phase 9/10 screens
- Info banners: Use `<div class="info-banner">` with blue background

Ensure responsive layout for all empty states (mobile-friendly).
  </action>
  <verify>Both screens show appropriate empty states, power drawer buttons exist and work</verify>
  <done>Empty states cover all scenarios, power drawer integrates with both screens</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Timeline has epistemic and causality toggles that work
- [ ] Timeline shows knowledge badges per character when epistemic toggle on
- [ ] Timeline shows causality arrows between events when causality toggle on
- [ ] Characters screen displays arc cards for each character
- [ ] "What They Know" button opens modal with character knowledge
- [ ] Both screens have comprehensive empty states
- [ ] Power drawer integrates with both screens
</verification>

<success_criteria>
- All tasks completed
- Timeline enhanced with epistemic and causality overlays
- Characters screen shows arcs and provides knowledge inspection
- All empty states implemented
- No console errors when toggling features
</success_criteria>

<output>
After completion, create `.planning/phases/11-gui-epistemic-reader-knowledge/11-03-SUMMARY.md`
</output>
