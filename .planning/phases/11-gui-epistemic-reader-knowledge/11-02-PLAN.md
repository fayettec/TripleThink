---
phase: 11-gui-epistemic-reader-knowledge
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - gui/js/screens/epistemic.js
  - gui/styles/screens.css
autonomous: true

must_haves:
  truths:
    - "User can compare knowledge states between multiple characters"
    - "User can see false beliefs highlighted with orange borders"
  artifacts:
    - path: "gui/js/screens/epistemic.js"
      provides: "Epistemic graph with comparison mode and false belief highlighting"
      min_lines: 150
    - path: "gui/styles/screens.css"
      provides: "Visual styling for false beliefs"
      contains: ".false-belief"
  key_links:
    - from: "epistemic.js"
      to: "/api/epistemic/knowledge"
      via: "fetches character knowledge states"
      pattern: "api\\.request.*epistemic/knowledge"
    - from: "epistemic.js"
      to: "/api/epistemic/beliefs"
      via: "fetches false beliefs"
      pattern: "api\\.request.*epistemic/beliefs"
---

<objective>
Enhance epistemic screen with character comparison and false belief visualization.

Purpose: Enable authors to visualize and compare what different characters know, highlighting false beliefs that drive dramatic tension.
Output: Full-featured epistemic screen with knowledge graph, comparison mode, and false belief highlighting.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/08-gui-core-infrastructure/08-02-SUMMARY.md

@gui/js/screens/epistemic.js
@gui/js/components/layer-switcher.js
@gui/js/state.js
@api/routes/epistemic.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement character knowledge comparison mode</name>
  <files>gui/js/screens/epistemic.js</files>
  <action>
Enhance EpistemicScreen.render() to support character knowledge comparison.

Current state: Stub screen with placeholder message (Phase 11 implementation).

New features:
1. **Character selector section** (top of screen):
   - Dropdown to select primary character (default: first character in project)
   - "Compare with..." dropdown to select secondary character (optional)
   - When both selected, show comparison view

2. **Knowledge graph visualization**:
   - Use D3.js force-directed layout (similar to causality-graph.js from Phase 9)
   - Nodes: facts/beliefs
   - Node colors:
     - Green: Known by both characters (shared knowledge)
     - Blue: Known only by primary character
     - Purple: Known only by secondary character
     - Orange: False beliefs (see Task 2)
   - Edges: relationships between facts (causes, contradicts, supports)

3. **Comparison diff panel** (when 2 characters selected):
   - Section 1: "Both know" - green badge with count
   - Section 2: "[Primary] knows but [Secondary] doesn't" - blue badge
   - Section 3: "[Secondary] knows but [Primary] doesn't" - purple badge
   - Section 4: "False beliefs" - orange badge (see Task 2)
   - Click badge to filter graph to that subset

API calls:
- GET /api/epistemic/knowledge/${characterId}?at=${timestamp} - get knowledge at current timestamp (from state.currentTimestamp)
- GET /api/epistemic/knowledge/${char1}/compare/${char2}?at=${timestamp} - get comparison (if endpoint exists, else compute client-side)

State integration:
- Subscribe to state.currentTimestamp changes to re-fetch knowledge
- Subscribe to state.selectedCharacter to default primary character selection
- Subscribe to state.viewMode to filter display (reader-view mode shows only reader-known facts)

Follow story-logic.js pattern for screen with tabs and state subscriptions.
Follow causality-graph.js pattern for D3 visualization.
  </action>
  <verify>Epistemic screen renders character selectors, D3 graph, comparison diff panel</verify>
  <done>User can select 2 characters, see knowledge comparison graph, filter by knowledge subset</done>
</task>

<task type="auto">
  <name>Task 2: Implement false belief highlighting</name>
  <files>gui/js/screens/epistemic.js, gui/styles/screens.css</files>
  <action>
Add false belief detection and highlighting to epistemic screen.

False belief definition:
- Belief held by character that contradicts world truth
- Example: Character believes "Alice is alive" but world truth is "Alice is dead"

Detection logic (in epistemic.js):
1. Get character's knowledge/beliefs from API: GET /api/epistemic/knowledge/${characterId}
2. Get world truth facts: GET /api/epistemic/world-truth?at=${timestamp}
3. Find beliefs where:
   - Character's fact.value !== world truth fact.value for same fact.id
   - OR character believes fact that doesn't exist in world truth
   - OR character doesn't know fact that exists in world truth AND is relevant to their decisions

Display in graph:
- False belief nodes: orange border (3px solid #ff9800)
- Tooltip on hover: "False belief: [Character] believes X but truth is Y"
- Click false belief node to show detail panel with:
  - Character's belief: [text]
  - Actual truth: [text]
  - Impact: [list of scenes where this false belief affects character's actions]

CSS styling (in screens.css):
```css
.epistemic-graph .node.false-belief {
  border: 3px solid #ff9800;
  background-color: #fff3e0;
}

.false-belief-tooltip {
  background: #ff9800;
  color: white;
  padding: 8px 12px;
  border-radius: 4px;
}

.false-belief-detail {
  border-left: 4px solid #ff9800;
  padding: 16px;
  background: #fff3e0;
}
```

API endpoints to use:
- GET /api/epistemic/beliefs/${characterId}?falseBeliefsOnly=true - get only false beliefs
- GET /api/epistemic/world-truth?at=${timestamp} - get ground truth at timestamp

If /api/epistemic/beliefs endpoint doesn't exist, compute client-side by comparing knowledge response with world truth.
  </action>
  <verify>False beliefs have orange borders, hover shows tooltip, click shows detail panel</verify>
  <done>Users can visually identify false beliefs in knowledge graph with distinct styling</done>
</task>

<task type="auto">
  <name>Task 3: Integrate layer switcher and add empty states</name>
  <files>gui/js/screens/epistemic.js</files>
  <action>
Complete epistemic screen integration with layer switcher and proper empty states.

Layer switcher integration:
- Render LayerSwitcher.init('layer-switcher-container') in render()
- Subscribe to state.viewMode changes
- Filter graph based on viewMode:
  - 'world-truth': Show all facts (no filtering)
  - 'character-view': Show only selected character's knowledge
  - 'reader-view': Show only facts revealed to reader (call ReaderKnowledgeTracker.getFacts from Plan 11-01)

Empty states:
1. No project selected:
   - Icon: ðŸ§ 
   - Message: "No project selected"
   - Hint: "Select a project to view epistemic states"

2. Project selected but no characters:
   - Icon: ðŸ‘¥
   - Message: "No characters in this project"
   - Hint: "Create characters to track knowledge states"

3. Project + characters but no knowledge data:
   - Icon: ðŸ“–
   - Message: "No knowledge data yet"
   - Hint: "Knowledge states are tracked per event. Create events and assign character knowledge."

4. Comparison mode but only 1 character selected:
   - Show single character knowledge graph (no diff panel)
   - Hint above graph: "Select a second character to compare knowledge"

Power drawer integration:
- Add power drawer toggle button to header (follow pattern from story-logic.js)
- Power drawer shows selected node details when node clicked in graph

Follow patterns from story-logic.js for screen structure and empty states.
Ensure all state subscriptions use unsubscribe cleanup pattern.
  </action>
  <verify>Layer switcher renders, filters graph by viewMode, empty states display appropriately</verify>
  <done>Epistemic screen fully functional with layer switching, empty states, power drawer integration</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Character comparison mode works with 2 selectors and diff panel
- [ ] D3 knowledge graph renders with color-coded nodes
- [ ] False beliefs have orange borders and show details on click
- [ ] Layer switcher filters graph by viewMode
- [ ] Empty states handle all scenarios (no project, no characters, no data)
- [ ] Power drawer integration works
</verification>

<success_criteria>
- All tasks completed
- Epistemic screen is no longer a stub
- Knowledge comparison works for 2 characters
- False beliefs visually distinct with orange borders
- Layer switching filters graph appropriately
</success_criteria>

<output>
After completion, create `.planning/phases/11-gui-epistemic-reader-knowledge/11-02-SUMMARY.md`
</output>
