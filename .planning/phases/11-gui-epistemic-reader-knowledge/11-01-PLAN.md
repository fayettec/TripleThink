---
phase: 11-gui-epistemic-reader-knowledge
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - gui/js/components/reader-knowledge-tracker.js
  - gui/js/components/dramatic-irony-panel.js
  - gui/js/components/scene-editor.js
  - gui/js/components/layer-switcher.js
autonomous: true

must_haves:
  truths:
    - "User can track which facts are revealed to the reader in each scene"
    - "User can see dramatic irony warnings when characters act on incomplete knowledge"
    - "User can switch to Reader View mode to see only reader-known facts"
  artifacts:
    - path: "gui/js/components/reader-knowledge-tracker.js"
      provides: "Reader knowledge tracking per scene"
      min_lines: 50
    - path: "gui/js/components/dramatic-irony-panel.js"
      provides: "Reader vs character knowledge comparison"
      min_lines: 60
    - path: "gui/js/components/scene-editor.js"
      provides: "Scene editing with reader knowledge section"
      min_lines: 100
  key_links:
    - from: "scene-editor.js"
      to: "reader-knowledge-tracker.js"
      via: "renders reader knowledge section"
      pattern: "ReaderKnowledgeTracker\\.(render|init)"
    - from: "scene-editor.js"
      to: "dramatic-irony-panel.js"
      via: "renders dramatic irony warnings"
      pattern: "DramaticIronyPanel\\.(render|check)"
    - from: "layer-switcher.js"
      to: "state.viewMode"
      via: "toggles Reader View mode"
      pattern: "viewMode.*reader-view"
---

<objective>
Implement reader knowledge tracking with dramatic irony detection.

Purpose: Enable authors to track what readers know vs what characters know, catching dramatic irony opportunities and knowledge inconsistencies.
Output: Reader knowledge tracker component, dramatic irony panel, enhanced scene editor with reader knowledge section, Reader View in layer switcher.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@.planning/phases/08-gui-core-infrastructure/08-02-SUMMARY.md
@.planning/phases/09-gui-logic-visualization/09-01-SUMMARY.md

@gui/js/state.js
@gui/js/components/layer-switcher.js
@gui/js/screens/narrative.js
@api/routes/epistemic.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create reader-knowledge-tracker.js component</name>
  <files>gui/js/components/reader-knowledge-tracker.js</files>
  <action>
Create ReaderKnowledgeTracker component that tracks facts revealed to reader per scene.

Component structure:
- render(sceneId) - Returns HTML string with fact list for scene
- addFact(sceneId, factId) - Adds fact to scene's reader knowledge
- removeFact(sceneId, factId) - Removes fact from scene
- getFacts(sceneId) - Returns array of fact IDs reader knows by this scene

UI features:
- List of facts revealed in current scene
- "Add Fact" button opening fact selector modal
- Each fact with remove button (✕)
- Empty state: "No facts revealed to reader in this scene"

Data storage:
- Use api.request('GET', `/api/epistemic/reader-knowledge/${sceneId}`) to fetch
- Use api.request('POST', '/api/epistemic/reader-knowledge', {sceneId, factId}) to add
- Local state tracking for immediate UI updates

Follow patterns from arc-card.js and conflict-card.js for component structure.
Export object with methods, not class.
  </action>
  <verify>File exists, exports ReaderKnowledgeTracker object with render/addFact/removeFact/getFacts methods</verify>
  <done>Component renders fact list, allows adding/removing facts, fetches from API</done>
</task>

<task type="auto">
  <name>Task 2: Create dramatic-irony-panel.js component</name>
  <files>gui/js/components/dramatic-irony-panel.js</files>
  <action>
Create DramaticIronyPanel component that compares reader knowledge vs character knowledge to detect dramatic irony.

Component structure:
- render(sceneId, characterId) - Returns HTML string with irony analysis
- checkForIrony(sceneId, characterId) - Returns array of irony instances
- highlight(elementId) - Highlights scene element with irony warning

Irony detection logic:
1. Get reader knowledge at scene (cumulative from all prior scenes)
2. Get character knowledge at scene (from /api/epistemic/knowledge/${characterId}?at=${sceneTimestamp})
3. Find facts reader knows but character doesn't (dramatic irony)
4. Find facts character knows but reader doesn't (mystery/surprise)

UI display:
- Orange warning badge if irony detected
- Expandable panel showing:
  - "Reader knows but [Character] doesn't": [fact list]
  - "[Character] knows but reader doesn't": [fact list]
- Empty state: "No dramatic irony detected"

API calls:
- GET /api/epistemic/reader-knowledge/cumulative/${sceneId} - all facts reader knows by scene
- GET /api/epistemic/knowledge/${characterId}?at=${timestamp} - character knowledge at timestamp

Follow epistemic.js screen patterns for knowledge comparison.
  </action>
  <verify>File exists, exports DramaticIronyPanel with render/checkForIrony/highlight methods</verify>
  <done>Panel compares knowledge, displays irony warnings, highlights affected elements</done>
</task>

<task type="auto">
  <name>Task 3: Create scene-editor.js and enhance layer-switcher.js</name>
  <files>gui/js/components/scene-editor.js, gui/js/components/layer-switcher.js</files>
  <action>
Create scene-editor.js component (currently doesn't exist) with reader knowledge section and dramatic irony warnings.

Scene editor structure:
- render(sceneId) - Returns HTML modal with scene editing form
- init(sceneId) - Initializes editor with scene data
- save() - Saves scene changes to API
- cancel() - Closes editor without saving

Editor sections:
1. Basic scene info (title, description, timestamp)
2. **Facts Revealed to Reader** section (new):
   - Renders ReaderKnowledgeTracker.render(sceneId)
   - Add/remove facts interface
3. **Dramatic Irony Warnings** section (new):
   - Renders DramaticIronyPanel.render(sceneId, presentCharacterIds[0])
   - Orange warning badge if irony detected
4. Present entities section (characters, objects, locations present in scene)
5. Save/Cancel buttons

Dramatic irony integration:
- For each present character, check DramaticIronyPanel.checkForIrony(sceneId, charId)
- Show aggregated warning count: "⚠️ 3 dramatic irony instances detected"
- Click warning to expand panel with details

Layer switcher enhancement:
- Update gui/js/components/layer-switcher.js to include Reader View mode
- Current modes: World Truth, Character View
- Add third button: Reader View
- On click, state.update('viewMode', 'reader-view')
- Active styling when viewMode === 'reader-view'

Follow narrative-tree-editor.js pattern for modal editor structure.
Scene editor called from narrative.js screen when user clicks scene in tree.
  </action>
  <verify>scene-editor.js exists with full modal structure, layer-switcher.js includes Reader View button</verify>
  <done>Scene editor opens from narrative screen, shows reader knowledge and irony warnings, layer switcher has 3 modes</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] ReaderKnowledgeTracker renders fact lists and allows add/remove
- [ ] DramaticIronyPanel detects and displays irony warnings
- [ ] Scene editor opens from narrative screen with all sections
- [ ] Layer switcher includes Reader View mode (3 buttons total)
- [ ] All components follow vanilla JS pattern (no frameworks)
</verification>

<success_criteria>
- All tasks completed
- All 4 files created/modified
- Components integrate with existing screens
- API calls match epistemic route patterns
- No console errors when rendering components
</success_criteria>

<output>
After completion, create `.planning/phases/11-gui-epistemic-reader-knowledge/11-01-SUMMARY.md`
</output>
